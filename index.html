<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartSched: AI Timetable & Attendance</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth;
        }
        /* --- Smooth Transitions & Animations --- */
        .smooth-transition {
            transition: all 0.3s ease-in-out;
        }
        .modal {
            transition: opacity 0.25s ease, transform 0.25s ease;
            visibility: visible;
        }
        .modal.hidden {
            opacity: 0;
            transform: scale(0.95);
            visibility: hidden;
            pointer-events: none;
        }
        .main-view-transition {
            transition: opacity 0.4s ease, transform 0.4s ease;
        }
        .main-view-transition.hidden {
            opacity: 0;
            transform: translateY(20px);
            pointer-events: none;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-fade-in {
            animation: fadeIn 0.8s ease-in-out forwards;
        }
        .loader {
            width: 24px;
            height: 24px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #ef4444;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        
        /* --- UI Element Styles --- */
        .current-class {
            background-color: #fee2e2 !important; /* red-100 */
            border: 2px solid #dc2626; /* red-600 */
            transform: scale(1.02);
        }
        #timetable-container td:not(.current-class):hover {
            background-color: #f3f4f6;
        }
        #timetable-container.editable td {
            cursor: pointer;
        }
        
        /* Attendance toggle styles */
        .attendance-toggle {
            display: inline-flex;
            border-radius: 9999px;
            overflow: hidden;
            border: 1px solid #d1d5db;
        }
        .attendance-toggle button {
            padding: 4px 12px;
            font-size: 0.875rem;
            line-height: 1.25rem;
            transition: background-color 0.2s;
        }
        .attendance-toggle .present.active {
            background-color: #22c55e;
            color: white;
        }
        .attendance-toggle .absent.active {
            background-color: #ef4444;
            color: white;
        }

        /* Landing Page Animations & Colors */
        .reveal {
            opacity: 0;
            transform: translateY(40px);
            transition: opacity 0.8s ease-out, transform 0.8s ease-out;
        }
        .reveal.visible {
            opacity: 1;
            transform: translateY(0);
        }
        
        .feature-card-hover:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }
        :root {
            --brand-red: #B91C1C;
            --brand-beige: #F5F5DC; 
        }
        #landing-page {
             background-color: #FAF8F5; /* A soft beige alternative */
        }
        .brand-text { color: var(--brand-red); }
        .brand-bg { background-color: var(--brand-red); }
        .hover\:brand-bg:hover { background-color: #991B1B; }

        /* Hide default password reveal icons */
        input[type="password"]::-ms-reveal,
        input[type="password"]::-webkit-password-reveal-button {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 antialiased">

    <!-- Landing Page -->
    <div id="landing-page">
        <nav class="bg-white/80 backdrop-blur-md sticky top-0 z-50 shadow-sm">
            <div class="container mx-auto px-6 py-3 flex justify-between items-center">
                <div class="flex items-center space-x-2">
                     <svg class="w-8 h-8 brand-text" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                     <span class="text-xl font-bold brand-text">SmartSched</span>
                </div>
                <div>
                    <a href="#features" class="text-gray-600 hover:brand-text px-3 py-2 rounded-md font-medium smooth-transition">Features</a>
                    <a href="#feedback" class="text-gray-600 hover:brand-text px-3 py-2 rounded-md font-medium smooth-transition">Feedback</a>
                    <button id="launch-app-btn-nav" class="brand-bg hover:brand-bg text-white font-bold py-2 px-4 rounded-lg ml-4 smooth-transition">Login</button>
                </div>
            </div>
        </nav>

        <header class="bg-white">
            <div class="container mx-auto px-6 py-16 md:py-24 text-center">
                <div class="animate-fade-in">
                    <h1 class="text-4xl md:text-6xl font-extrabold text-gray-900 leading-tight">
                        Intelligent Academic Management
                        <span class="block brand-text">Powered by AI</span>
                    </h1>
                    <p class="mt-6 max-w-2xl mx-auto text-lg text-gray-600">
                        A unified platform for students, faculty, and administrators to streamline academic life with powerful, intuitive tools.
                    </p>
                    <button id="launch-app-btn-hero" class="mt-8 brand-bg hover:brand-bg text-white font-bold py-3 px-8 rounded-full text-lg smooth-transition transform hover:scale-105 shadow-lg">
                        Get Started
                    </button>
                </div>
            </div>
        </header>

        <section id="features" class="py-20">
            <div class="container mx-auto px-6">
                <div class="text-center mb-16 reveal">
                    <h2 class="text-3xl md:text-4xl font-bold text-gray-900">A Tailored Experience for Everyone</h2>
                    <p class="mt-4 text-gray-600 max-w-2xl mx-auto">Discover features designed specifically for your role on campus, enhanced with the power of AI.</p>
                </div>

                <!-- Feature 1: Students -->
                <div class="flex flex-wrap items-center mb-20 reveal">
                    <div class="w-full md:w-1/2 p-4">
                        <div class="bg-red-100/50 p-2 rounded-lg">
                            <img src="https://images.unsplash.com/photo-1522202176988-66273c2fd55f?q=80&w=2071&auto=format&fit=crop" alt="A student using a laptop to manage their schedule" class="rounded-lg shadow-xl w-full h-[400px] object-cover">
                        </div>
                    </div>
                    <div class="w-full md:w-1/2 p-4">
                        <h3 class="text-3xl font-bold mb-4 text-gray-900">For Students</h3>
                        <p class="text-gray-600 mb-6">Stay organized and on top of your academic journey. This platform provides all the tools you need to succeed in one simple interface.</p>
                        <ul class="space-y-3">
                            <li class="flex items-start"><span class="brand-text mr-3 mt-1">✔</span><span><strong>Live Timetable Access:</strong> View your daily and weekly class schedule anytime, anywhere.</span></li>
                            <li class="flex items-start"><span class="brand-text mr-3 mt-1">✔</span><span><strong>Attendance Tracking:</strong> Monitor your attendance percentage for each subject in real-time.</span></li>
                            <li class="flex items-start"><span class="brand-text mr-3 mt-1">✔</span><span><strong>AI-Powered Tutor:</strong> ✨ Get instant help with difficult concepts, generate study plans, and brainstorm project ideas.</span></li>
                        </ul>
                    </div>
                </div>

                <!-- Feature 2: Faculty -->
                <div class="flex flex-wrap items-center mb-20 flex-row-reverse reveal">
                     <div class="w-full md:w-1/2 p-4">
                        <div class="bg-blue-100/50 p-2 rounded-lg">
                           <img src="https://images.unsplash.com/photo-1543269865-cbf427effbad?q=80&w=2070&auto=format&fit=crop" alt="A faculty member teaching in a classroom" class="rounded-lg shadow-xl w-full h-[400px] object-cover">
                        </div>
                    </div>
                    <div class="w-full md:w-1/2 p-4">
                        <h3 class="text-3xl font-bold mb-4 text-gray-900">For Faculty</h3>
                        <p class="text-gray-600 mb-6">Focus on teaching, not paperwork. Our tools simplify your administrative tasks so you can dedicate more time to your students.</p>
                        <ul class="space-y-3">
                             <li class="flex items-start"><span class="text-blue-500 mr-3 mt-1">✔</span><span><strong>Consolidated Schedule:</strong> See all your assigned classes for the week in a single, clear view.</span></li>
                            <li class="flex items-start"><span class="text-blue-500 mr-3 mt-1">✔</span><span><strong>Effortless Attendance:</strong> Take attendance with a few clicks or use the ✨ AI Camera Scan for instant, automated marking.</span></li>
                            <li class="flex items-start"><span class="text-blue-500 mr-3 mt-1">✔</span><span><strong>Smart Leave Management:</strong> ✨ Submit leave requests with AI-drafted reasons and get suggestions for potential substitutes.</span></li>
                        </ul>
                    </div>
                </div>

                 <!-- Feature 3: HODs -->
                <div class="flex flex-wrap items-center reveal">
                    <div class="w-full md:w-1/2 p-4">
                        <div class="bg-green-100/50 p-2 rounded-lg">
                           <img src="https://images.unsplash.com/photo-1552664730-d307ca884978?q=80&w=2070&auto=format&fit=crop" alt="An administrator analyzing data on a screen" class="rounded-lg shadow-xl w-full h-[400px] object-cover">
                        </div>
                    </div>
                    <div class="w-full md:w-1/2 p-4">
                        <h3 class="text-3xl font-bold mb-4 text-gray-900">For Administrators</h3>
                        <p class="text-gray-600 mb-6">Gain a high-level overview of your department's operations and make data-driven decisions with powerful AI insights.</p>
                         <ul class="space-y-3">
                            <li class="flex items-start"><span class="text-green-500 mr-3 mt-1">✔</span><span><strong>Drag & Drop Timetables:</strong> Effortlessly create and modify class schedules for any department.</span></li>
                            <li class="flex items-start"><span class="text-green-500 mr-3 mt-1">✔</span><span><strong>AI Workload Analysis:</strong> ✨ Instantly analyze faculty workloads to ensure fair and balanced distribution of classes.</span></li>
                            <li class="flex items-start"><span class="text-green-500 mr-3 mt-1">✔</span><span><strong>Automated Rescheduling:</strong> ✨ Approve faculty leaves and let the AI automatically find substitutes or reschedule classes to avoid disruption.</span></li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <section id="feedback" class="py-20 bg-white">
            <div class="container mx-auto px-6">
                 <div class="text-center mb-12 reveal">
                    <h2 class="text-3xl md:text-4xl font-bold text-gray-900">What Our Users Are Saying</h2>
                 </div>

                 <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-8 mb-16 reveal">
                    <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                        <p class="text-gray-600 italic">"The AI rescheduling for faculty leaves is a game-changer. What used to take hours of manual coordination now takes a single click. SmartSched has significantly improved our department's efficiency."</p>
                        <p class="mt-4 font-bold text-gray-800">- Dr. Anjali Sharma</p>
                        <p class="text-sm text-gray-500">Head of Department, CSE</p>
                    </div>
                    <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                        <p class="text-gray-600 italic">"As a student, having my entire schedule and real-time attendance in one place is incredibly helpful. The AI tutor feature has also been amazing for clarifying tough concepts before exams."</p>
                        <p class="mt-4 font-bold text-gray-800">- Rohan Verma</p>
                        <p class="text-sm text-gray-500">III Year Student, ECE</p>
                    </div>
                     <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                        <p class="text-gray-600 italic">"Taking attendance used to be a tedious start to every lecture. The AI Camera scan is surprisingly fast and accurate. It gives me back valuable teaching time at the start of each class."</p>
                        <p class="mt-4 font-bold text-gray-800">- Prof. Sameer Khan</p>
                        <p class="text-sm text-gray-500">Faculty, Mechanical Engg.</p>
                    </div>
                     <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                        <p class="text-gray-600 italic">"I love that I can just drag and drop classes to make adjustments to the timetable. The AI-generated schedule options gave us a fantastic, balanced starting point this semester."</p>
                        <p class="mt-4 font-bold text-gray-800">- Dr. Priya Nair</p>
                        <p class="text-sm text-gray-500">Head of Department, Civil Engg.</p>
                    </div>
                </div>
                
                 <div class="text-center mb-12 reveal">
                    <h2 class="text-2xl font-bold text-gray-900">Help Us Improve</h2>
                    <p class="mt-4 text-gray-600 max-w-2xl mx-auto">We value your feedback. Let us know what you think or if you've encountered any issues.</p>
                </div>

                <div class="max-w-2xl mx-auto reveal">
                    <form id="feedback-form" class="bg-gray-50 p-8 rounded-xl border border-gray-200">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label for="feedback-name" class="block text-sm font-medium text-gray-700">Name</label>
                                <input type="text" id="feedback-name" required class="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm">
                            </div>
                             <div>
                                <label for="feedback-email" class="block text-sm font-medium text-gray-700">Email</label>
                                <input type="email" id="feedback-email" required class="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm">
                            </div>
                        </div>
                         <div class="mb-6">
                            <label for="feedback-message" class="block text-sm font-medium text-gray-700">Message</label>
                            <textarea id="feedback-message" rows="5" required class="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm"></textarea>
                        </div>
                        <div class="text-center">
                            <button type="submit" class="brand-bg hover:brand-bg text-white font-bold py-3 px-8 rounded-full text-lg smooth-transition">Submit Feedback</button>
                        </div>
                    </form>
                    <p id="feedback-success" class="hidden text-center mt-6 text-green-600 font-semibold">Thank you for your feedback!</p>
                </div>
            </div>
        </section>

        <footer class="bg-gray-800 text-white">
            <div class="container mx-auto px-6 py-6 text-center">
                <p>&copy; 2025 SmartSched Academic Solutions. All Rights Reserved.</p>
            </div>
        </footer>

    </div>

    <!-- Main Application Container (Initially Hidden) -->
    <div id="app" class="hidden min-h-screen container mx-auto p-4 md:p-8">
        <header class="text-center mb-8 animate-fade-in relative">
             <button id="back-to-landing-btn" class="absolute top-0 left-0 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg smooth-transition">
                &larr; Home
            </button>
            <h1 class="text-3xl md:text-4xl font-bold text-red-800">SmartSched Portal</h1>
            <p class="text-gray-600 mt-2">Your Timetable & Attendance Dashboard</p>
        </header>

        <!-- Role Selection View -->
        <div id="role-selection-view" class="animate-fade-in">
            <h2 class="text-center text-xl md:text-2xl font-semibold mb-6">Who are you?</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-4xl mx-auto">
                <div id="select-student" class="bg-white p-8 rounded-xl shadow-md hover:shadow-lg hover:scale-105 smooth-transition cursor-pointer text-center">
                    <svg class="w-16 h-16 text-red-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
                    <h3 class="text-xl font-bold">Student</h3>
                    <p class="text-slate-500 mt-1">View schedule & attendance</p>
                </div>
                <div id="select-faculty" class="bg-white p-8 rounded-xl shadow-md hover:shadow-lg hover:scale-105 smooth-transition cursor-pointer text-center">
                    <svg class="w-16 h-16 text-red-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                    <h3 class="text-xl font-bold">Faculty</h3><p class="text-slate-500 mt-1">Login to take attendance</p>
                </div>
                <div id="select-hod" class="bg-white p-8 rounded-xl shadow-md hover:shadow-lg hover:scale-105 smooth-transition cursor-pointer text-center">
                    <svg class="w-16 h-16 text-red-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>
                    <h3 class="text-xl font-bold">HOD</h3><p class="text-slate-500 mt-1">Manage & view reports</p>
                </div>
            </div>
        </div>

        <!-- Main View (for timetables and attendance) -->
        <div id="main-view" class="hidden main-view-transition">
            <div class="max-w-7xl mx-auto bg-white p-6 rounded-xl shadow-lg">
                <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                    <h2 id="view-title" class="text-2xl font-bold">Dashboard</h2>
                    <div>
                         <button id="view-leave-requests-btn" class="hidden bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded-lg smooth-transition mr-2">View Leaves</button>
                         <button id="analyze-workload-btn" class="hidden bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg smooth-transition mr-2">✨ Analyze Workload</button>
                         <button id="view-attendance-report-btn" class="hidden bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg smooth-transition mr-2">View Attendance</button>
                         <button id="manage-time-slots-btn" class="hidden bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg smooth-transition mr-2">Manage Time Slots</button>
                         <button id="manage-students-btn" class="hidden bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg smooth-transition mr-2">Manage Students</button>
                         <button id="manage-faculty-btn" class="hidden bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg smooth-transition mr-2">Manage Faculty</button>
                         <button id="back-button" class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold py-2 px-4 rounded-lg smooth-transition">Back</button>
                    </div>
                </div>
                
                <div id="faculty-actions" class="hidden justify-end mb-4 gap-2">
                    <button id="my-leave-status-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg smooth-transition">My Leave Status</button>
                    <button id="take-leave-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded-lg smooth-transition">Take Leave</button>
                </div>

                <div id="faculty-current-class-view" class="hidden mb-6 p-4 bg-red-100 border-l-4 border-red-500 rounded-r-lg flex flex-wrap justify-center md:justify-between items-center gap-4"></div>
                
                <div id="filters" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6 items-end"></div>
                
                <div id="student-attendance-summary" class="hidden mb-6 p-4 border rounded-lg bg-gray-50"></div>

                <div id="timetable-container" class="overflow-x-auto"></div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="hod-login-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4 modal">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm"><h3 class="text-2xl font-bold text-center mb-6">HOD Login</h3><form id="hod-login-form"><div class="mb-4"><label for="username" class="block text-sm font-medium text-slate-700">Username</label><input type="text" id="username" placeholder="Enter username" required class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm"></div><div class="mb-6 relative"><label for="password" class="block text-sm font-medium text-slate-700">Password</label><input type="password" id="password" placeholder="Enter password" required class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm pr-10"><button type="button" id="toggle-hod-password" class="absolute inset-y-0 right-0 top-7 flex items-center pr-3 text-gray-400 hover:text-gray-600 focus:outline-none"></button></div><p id="login-error" class="text-red-500 text-sm text-center mb-4 hidden"></p><div class="flex items-center justify-between"><button type="button" data-close-modal class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold py-2 px-4 rounded-lg smooth-transition">Cancel</button><button type="submit" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg smooth-transition">Login</button></div></form></div>
    </div>
    <div id="faculty-login-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4 modal">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm"><h3 class="text-2xl font-bold text-center mb-6">Faculty Login</h3><form id="faculty-login-form"><div class="mb-4"><label for="faculty-username" class="block text-sm font-medium text-slate-700">Full Name</label><select id="faculty-username" required class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm"></select></div><div class="mb-6 relative"><label for="faculty-password" class="block text-sm font-medium text-slate-700">Password</label><input type="password" id="faculty-password" placeholder="Enter password" required class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm pr-10"><button type="button" id="toggle-faculty-password" class="absolute inset-y-0 right-0 top-7 flex items-center pr-3 text-gray-400 hover:text-gray-600 focus:outline-none"></button></div><p id="faculty-login-error" class="text-red-500 text-sm text-center mb-4 hidden"></p><div class="flex items-center justify-between"><button type="button" data-close-modal class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold py-2 px-4 rounded-lg smooth-transition">Cancel</button><button type="submit" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg smooth-transition">Login</button></div></form></div>
    </div>
    <div id="student-login-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4 modal">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md"><h3 class="text-2xl font-bold text-center mb-6">Student Login</h3><form id="student-login-form"><div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4"><div id="student-dept-select-container"></div><div id="student-year-select-container"></div><div id="student-section-select-container"></div></div><div class="mb-6" id="student-name-select-container" class="hidden"><label for="student-name-select" class="block text-sm font-medium text-slate-700">Your Name</label><select id="student-name-select" required class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm disabled:bg-slate-100" disabled><option value="">Select your class first...</option></select></div><div class="flex items-center justify-between"><button type="button" data-close-modal class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold py-2 px-4 rounded-lg smooth-transition">Cancel</button><button type="submit" id="student-login-submit-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg smooth-transition disabled:bg-red-300" disabled>View Dashboard</button></div></form></div>
    </div>
    <div id="edit-slot-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4 modal">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md"><h3 id="edit-modal-title" class="text-2xl font-bold text-center mb-6">Update Slot</h3><form id="edit-slot-form"><input type="hidden" id="edit-day"><input type="hidden" id="edit-slot-index"><div class="mb-4"><label for="subject-select" class="block text-sm font-medium text-slate-700">Subject</label><select id="subject-select" class="mt-1 block w-full p-2 border border-slate-300 rounded-md"></select></div><div class="mb-6"><label for="faculty-select-modal" class="block text-sm font-medium text-slate-700">Faculty</label><select id="faculty-select-modal" class="mt-1 block w-full p-2 border border-slate-300 rounded-md"></select></div><div class="flex items-center justify-between"><button type="button" data-close-modal class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold py-2 px-4 rounded-lg smooth-transition">Cancel</button><button type="submit" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg smooth-transition">Update & Save</button></div></form></div>
    </div>
    <div id="manage-faculty-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4 modal">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg"><h3 id="manage-faculty-title" class="text-2xl font-bold text-center mb-6">Manage Faculty</h3><div id="faculty-list" class="max-h-64 overflow-y-auto mb-4 border rounded-lg p-3"></div><form id="add-faculty-form" class="flex gap-2 items-center mb-6"><input type="text" id="new-faculty-name" placeholder="Enter new faculty name" required class="flex-grow p-2 border border-slate-300 rounded-md"><button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg smooth-transition">Add</button></form><p id="faculty-error" class="text-red-500 text-sm text-center mb-4 hidden"></p><div class="text-right"><button type="button" data-close-modal class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold py-2 px-4 rounded-lg smooth-transition">Done</button></div></div>
    </div>
    <div id="attendance-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-start z-50 p-4 pt-10 overflow-y-auto modal">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-2xl"><h3 id="attendance-modal-title" class="text-2xl font-bold text-center mb-2">Take Attendance</h3><p id="attendance-modal-subtitle" class="text-center text-slate-500 mb-6"></p><div class="flex justify-between items-center mb-4"><p class="text-sm text-slate-600">Total Students: <span id="student-count"></span></p><button id="mark-all-present-btn" class="bg-green-100 text-green-800 text-sm font-semibold py-1 px-3 rounded-full hover:bg-green-200 smooth-transition">Mark All Present</button></div><form id="attendance-form"><div id="student-list-container" class="max-h-96 overflow-y-auto space-y-2 border rounded-lg p-3"></div><div class="flex items-center justify-between mt-6"><button type="button" data-close-modal class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold py-2 px-4 rounded-lg smooth-transition">Cancel</button><button type="submit" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg smooth-transition">Save Attendance</button></div></form></div>
    </div>
    <div id="attendance-report-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-start z-50 p-4 pt-10 overflow-y-auto modal">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-4xl"><h3 id="report-modal-title" class="text-2xl font-bold text-center mb-6">Attendance Report</h3><div class="mb-4 flex flex-wrap items-center gap-4"><label for="report-date" class="font-semibold">Select Date:</label><input type="date" id="report-date" class="p-2 border rounded-md"><button id="get-attendance-insights-btn" class="bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg smooth-transition">✨ Get Attendance Insights</button></div><div id="report-container" class="overflow-x-auto"></div><div class="text-right mt-6"><button type="button" data-close-modal class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold py-2 px-4 rounded-lg smooth-transition">Close</button></div></div>
    </div>
    <div id="ask-doubt-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4 modal">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg">
            <h3 class="text-2xl font-bold text-center mb-6">Ask the AI Tutor</h3>
            <form id="ask-doubt-form">
                <div class="mb-4">
                    <label for="doubt-subject-select" class="block text-sm font-medium text-slate-700">Which subject is your question about?</label>
                    <select id="doubt-subject-select" required class="mt-1 block w-full p-2 border border-slate-300 rounded-md"></select>
                </div>
                <div class="mb-6">
                    <label for="doubt-textarea" class="block text-sm font-medium text-slate-700">Enter your question</label>
                    <textarea id="doubt-textarea" rows="4" required placeholder="e.g., Can you explain the difference between TCP and UDP?" class="mt-1 block w-full p-2 border border-slate-300 rounded-md"></textarea>
                </div>
                <div class="flex items-center justify-between">
                    <button type="button" data-close-modal class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold py-2 px-4 rounded-lg smooth-transition">Cancel</button>
                    <button type="submit" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg smooth-transition">✨ Get Explanation</button>
                </div>
            </form>
        </div>
    </div>
    <div id="take-leave-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4 modal">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg">
            <h3 class="text-2xl font-bold text-center mb-6">Request Leave</h3>
            <form id="take-leave-form">
                <div class="mb-4">
                    <label for="leave-date" class="block text-sm font-medium text-slate-700">Date of Leave</label>
                    <input type="date" id="leave-date" required class="mt-1 block w-full p-2 border border-slate-300 rounded-md">
                </div>
                <div class="mb-6">
                    <label for="leave-reason" class="block text-sm font-medium text-slate-700">Reason for Leave (brief)</label>
                    <textarea id="leave-reason" rows="3" required placeholder="e.g., Personal emergency, attending a conference, etc." class="mt-1 block w-full p-2 border border-slate-300 rounded-md"></textarea>
                    <div class="text-right mt-2">
                        <button type="button" id="draft-leave-reason-btn" class="text-sm bg-purple-100 text-purple-800 font-semibold py-1 px-3 rounded-full hover:bg-purple-200 smooth-transition">
                            ✨ Draft with AI
                        </button>
                    </div>
                </div>
                <div class="flex items-center justify-between">
                    <button type="button" data-close-modal class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold py-2 px-4 rounded-lg smooth-transition">Cancel</button>
                    <button type="submit" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg smooth-transition">Submit Request</button>
                </div>
            </form>
        </div>
    </div>
    <div id="view-leaves-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-start z-50 p-4 pt-10 overflow-y-auto modal">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-3xl">
            <h3 class="text-2xl font-bold text-center mb-6">Faculty Leave Requests</h3>
            <div id="leave-requests-list" class="max-h-96 overflow-y-auto space-y-3">
                 <!-- Leave requests will be populated here by JavaScript -->
            </div>
            <div class="text-right mt-6">
                <button type="button" data-close-modal class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold py-2 px-4 rounded-lg smooth-transition">Close</button>
            </div>
        </div>
    </div>
    
    <!-- New Modals -->
    <div id="rejection-reason-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4 modal">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg">
            <h3 class="text-2xl font-bold text-center mb-6">Rejection Reason</h3>
            <form id="rejection-reason-form">
                <input type="hidden" id="rejection-leave-index">
                <div class="mb-6">
                    <label for="rejection-reason-textarea" class="block text-sm font-medium text-slate-700">Please provide a reason for rejecting this leave request.</label>
                    <textarea id="rejection-reason-textarea" rows="4" required placeholder="e.g., Due to critical project deadlines..." class="mt-1 block w-full p-2 border border-slate-300 rounded-md"></textarea>
                </div>
                <div class="flex items-center justify-between">
                    <button type="button" data-close-modal class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold py-2 px-4 rounded-lg smooth-transition">Cancel</button>
                    <button type="submit" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg smooth-transition">Submit Rejection</button>
                </div>
            </form>
        </div>
    </div>

    <div id="manage-students-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-start z-50 p-4 pt-10 overflow-y-auto modal">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-3xl">
            <h3 class="text-2xl font-bold text-center mb-6">Manage Students</h3>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
                <div id="ms-dept-select-container"></div>
                <div id="ms-year-select-container"></div>
                <div id="ms-section-select-container"></div>
            </div>
            <div id="student-management-content" class="hidden">
                <div class="mb-6">
                    <h4 class="text-lg font-semibold mb-2">Current Students</h4>
                    <div id="student-management-list" class="max-h-64 overflow-y-auto border rounded-lg p-3"></div>
                </div>
                <div>
                    <h4 class="text-lg font-semibold mb-2">Add New Student</h4>
                    <form id="add-student-form" class="grid grid-cols-1 sm:grid-cols-3 gap-2 items-center">
                        <input type="text" id="new-student-id" placeholder="Student ID (e.g., 1610...)" required class="sm:col-span-1 p-2 border border-slate-300 rounded-md">
                        <input type="text" id="new-student-name" placeholder="Full Name" required class="sm:col-span-1 p-2 border border-slate-300 rounded-md">
                        <button type="submit" class="sm:col-span-1 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg smooth-transition">Add Student</button>
                    </form>
                    <p id="student-add-error" class="text-red-500 text-sm text-center mt-2 hidden"></p>
                </div>
            </div>
            <div class="text-right mt-6">
                <button type="button" data-close-modal class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold py-2 px-4 rounded-lg smooth-transition">Done</button>
            </div>
        </div>
    </div>
    
    <div id="project-idea-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4 modal">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg">
            <h3 class="text-2xl font-bold text-center mb-6">✨ Project Idea Generator</h3>
            <form id="project-idea-form">
                <div class="mb-6">
                    <label for="project-subject-select" class="block text-sm font-medium text-slate-700">Select a subject for project ideas</label>
                    <select id="project-subject-select" required class="mt-1 block w-full p-2 border border-slate-300 rounded-md"></select>
                </div>
                <div class="flex items-center justify-between">
                    <button type="button" data-close-modal class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold py-2 px-4 rounded-lg smooth-transition">Cancel</button>
                    <button type="submit" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg smooth-transition">Generate Ideas</button>
                </div>
            </form>
        </div>
    </div>

    <div id="ai-attendance-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4 modal">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg">
            <h3 class="text-2xl font-bold text-center mb-6">✨ AI-Powered Attendance</h3>
            <div id="ai-attendance-content">
                <!-- Content will be injected by JavaScript -->
            </div>
        </div>
    </div>
    
    <div id="manage-time-slots-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4 modal">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
            <h3 class="text-2xl font-bold text-center mb-6">Manage Time Slots</h3>
            <p class="text-sm text-slate-500 mb-4 text-center">Changes here will apply to all timetables.</p>
            <form id="manage-time-slots-form">
                <div id="time-slots-inputs" class="space-y-2 mb-6">
                    <!-- Inputs will be generated here -->
                </div>
                <div class="flex items-center justify-between">
                    <button type="button" data-close-modal class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold py-2 px-4 rounded-lg smooth-transition">Cancel</button>
                    <button type="submit" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg smooth-transition">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <div id="timetable-options-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-start z-50 p-4 pt-10 overflow-y-auto modal">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-6xl">
            <h3 class="text-2xl font-bold text-center mb-6">✨ AI Generated Timetable Options</h3>
            <p class="text-center text-slate-500 mb-6">The AI has generated a few options. Please review them and select the one that works best.</p>
            <div id="timetable-options-container" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Timetable options will be populated here -->
            </div>
            <div class="text-center mt-8">
                <button type="button" data-close-modal class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold py-2 px-4 rounded-lg smooth-transition">Cancel</button>
            </div>
        </div>
    </div>


    <!-- Gemini AI Modal -->
    <div id="gemini-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-[100] p-4 modal">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <h3 id="gemini-modal-title" class="text-2xl font-bold text-center mb-6 text-gray-800">✨ AI Assistant</h3>
            <div id="gemini-modal-content" class="flex-grow overflow-y-auto pr-2">
                <!-- Loading state -->
                <div id="gemini-loading" class="text-center py-8 hidden">
                    <div class="loader mx-auto mb-4"></div>
                    <p class="text-slate-600">Generating response...</p>
                </div>
                <!-- Result state -->
                <div id="gemini-result" class="prose max-w-none"></div>
            </div>
            <div id="gemini-modal-actions" class="text-right mt-6">
                <button type="button" data-close-modal class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold py-2 px-4 rounded-lg smooth-transition">Close</button>
            </div>
        </div>
    </div>


    <script type="module">
        // --- DATA (Non-DOM) ---
        let timeTableData = {};
        const STORAGE_KEY = 'smartSchedAcademicPortal_v1'; // Rebranded key
        const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"];
        let currentRole = null;
        let currentFacultyName = null;
        let currentClassInfoForAttendance = {};
        const apiKey = ""; // Canvas will provide this

        const scheduleResponseSchema = {
            type: 'OBJECT',
            properties: {
                'Monday': { type: 'ARRAY', items: { oneOf: [ { type: 'OBJECT', properties: { subject: { type: 'STRING' }, faculty: { type: 'STRING' } } }, { type: 'NULL' } ] } },
                'Tuesday': { type: 'ARRAY', items: { oneOf: [ { type: 'OBJECT', properties: { subject: { type: 'STRING' }, faculty: { type: 'STRING' } } }, { type: 'NULL' } ] } },
                'Wednesday': { type: 'ARRAY', items: { oneOf: [ { type: 'OBJECT', properties: { subject: { type: 'STRING' }, faculty: { type: 'STRING' } } }, { type: 'NULL' } ] } },
                'Thursday': { type: 'ARRAY', items: { oneOf: [ { type: 'OBJECT', properties: { subject: { type: 'STRING' }, faculty: { type: 'STRING' } } }, { type: 'NULL' } ] } },
                'Friday': { type: 'ARRAY', items: { oneOf: [ { type: 'OBJECT', properties: { subject: { type: 'STRING' }, faculty: { type: 'STRING' } } }, { type: 'NULL' } ] } },
            }
        };

        const rescheduleResponseSchema = {
            type: "ARRAY",
            items: {
                type: "OBJECT",
                properties: {
                    action: { type: "STRING" }, // e.g., "substitute", "reschedule", "no_change"
                    originalClass: { type: "OBJECT", properties: { dept: { type: "STRING" }, year: { type: "STRING" }, section: { type: "STRING" }, day: { type: "NUMBER" }, slotIndex: { type: "NUMBER" } } },
                    details: { type: "STRING" }, // Human-readable explanation of the change
                    changes: { type: "OBJECT", properties: { newFaculty: { type: "STRING" }, newDay: { type: "STRING" }, newSlotIndex: { type: "NUMBER" } } }
                }
            }
        };


        function toggleModal(modalId, show) {
            const modal = document.getElementById(modalId);
            if (show) modal.classList.remove('hidden');
            else modal.classList.add('hidden');
        }

        // --- GEMINI API FUNCTIONS ---
        async function callGeminiAPI(prompt, schema = null, showModal = true) {
            const geminiModal = document.getElementById('gemini-modal');
            const geminiLoading = document.getElementById('gemini-loading');
            const geminiResult = document.getElementById('gemini-result');
            
            if (showModal) {
                const geminiActions = document.getElementById('gemini-modal-actions');
                geminiActions.innerHTML = `<button type="button" data-close-modal class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold py-2 px-4 rounded-lg smooth-transition">Close</button>`;

                toggleModal('gemini-modal', true);
                geminiLoading.classList.remove('hidden');
                geminiResult.innerHTML = '';
            }

            const baseUrl = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent';
            const apiUrl = apiKey ? `${baseUrl}?key=${apiKey}` : baseUrl;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
            };
             if (schema) {
                payload.generationConfig = {
                    responseMimeType: "application/json",
                    responseSchema: schema,
                };
            }

            try {
                let response;
                let backoff = 1000; // start with 1 second
                for (let i = 0; i < 5; i++) { // Retry up to 5 times
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        break; // Success
                    } else if (response.status === 429) { // Throttled
                        await new Promise(resolve => setTimeout(resolve, backoff));
                        backoff *= 2; // Exponential backoff
                    } else {
                        throw new Error(`API request failed with status ${response.status}`);
                    }
                }

                if (!response.ok) {
                    throw new Error('API request failed after multiple retries.');
                }
                
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (text) {
                    return text; // Return raw text, let caller handle it
                } else {
                    throw new Error('Invalid response structure from API.');
                }
            } catch (error) {
                console.error('Gemini API Error:', error);
                if (showModal) {
                    if (error.message.includes('401')) {
                        geminiResult.innerHTML = `<p class="text-red-500 font-bold">Authentication Error</p><p class="text-sm text-gray-600 mt-2">Could not connect to the AI service (Error 401). This might be due to a missing or invalid API key. Please ensure the application is configured correctly in the Canvas environment.</p>`;
                    } else {
                        geminiResult.innerHTML = `<p class="text-red-500">Sorry, an error occurred while contacting the AI assistant. Please try again later.</p><p class="text-sm text-gray-500 mt-2">${error.message}</p>`;
                    }
                }
                throw error; // Re-throw error so Promise.allSettled can catch it.
            } finally {
                if (showModal) {
                    geminiLoading.classList.add('hidden');
                }
            }
        }
        
        async function getGeminiTextOnly(prompt) {
            const baseUrl = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent';
            const apiUrl = apiKey ? `${baseUrl}?key=${apiKey}` : baseUrl;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            try {
                let response;
                let backoff = 1000;
                for (let i = 0; i < 5; i++) {
                    response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (response.ok) break;
                    if (response.status === 429) { await new Promise(resolve => setTimeout(resolve, backoff)); backoff *= 2; } 
                    else { throw new Error(`API request failed with status ${response.status}`); }
                }
                if (!response.ok) throw new Error('API request failed after multiple retries.');
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (text) return text;
                throw new Error('Invalid response structure from API.');
            } catch (error) {
                console.error('Gemini Text Only Error:', error);
                return `Sorry, an error occurred while drafting the message. Please write it manually. Error: ${error.message}`;
            }
        }


        // --- DATA FUNCTIONS (Non-DOM) ---
        function saveData() { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(timeTableData)); } catch (error) { console.error("Could not save data:", error); }}
        function loadData() { const savedData = localStorage.getItem(STORAGE_KEY); if (savedData) { timeTableData = JSON.parse(savedData); if(!timeTableData.leaves) timeTableData.leaves = []; } else { timeTableData = getInitialData(); } generateSchedules(); }
        function getInitialData() {
            let data = {
                departments: ["CSE", "ECE", "MECH", "CIVIL"],
                years: ["I", "II", "III", "IV"],
                sections: ["A", "B", "C", "D"],
                timeSlots: ["9:00-10:00", "10:00-11:00", "11:00-12:00", "12:00-1:00", "2:00-3:00", "3:00-4:00", "4:00-5:00"],
                subjects: { 
                    "I": ["Engg. Maths-I", "Physics", "Chemistry", "C Programming", "Engg. Graphics", "Workshop"], 
                    "II": ["DSP", "Discrete Maths (DM)", "DBMS", "EVS", "ETCE", "Basic Electronics (BE)", "Operations Research (OR)", "DSP LAB", "DBMS LAB", "BE LAB"], 
                    "III": ["Data Structures", "Python Programming", "Indian Constitution", "Probability and Statistics", "Effective Technical Communication in English", "Basic Electronics", "Finance and Accounting", "Data Structures Lab", "Python Programming Lab", "Basic Electronics Lab", "Library", "SPORTS", "BE LAB/DS LAB", "PP LAB/DS LAB", "BE LAB/PP LAB"], 
                    "IV": ["Machine Learning", "Cyber Security", "Cloud Computing", "Project Work"] 
                },
                faculty: { 
                    "CSE": ["Mr. Mohd Anjum Shadani", "Ms. Imrana Begum", "Ms. Afsha Sultana", "Ms. Humera Begum", "Ms. Saba Fatima", "Ms. Maimoona Arshiya", "Ms. Azeera Shaheen", "Mr. Abdul Muqeet", "Ms. Tahera Abid", "Dr. Farheen Sultana", "Mr. Khader", "Dr. Khasim Ali", "Ms. Saba", "Ms. Qudsia", "Ms. Jameel Unisa", "Ms. Qudsia Kamal"], 
                    "ECE": ["Prof. N. Tesla", "Dr. M. Curie", "Prof. A. Bell"], 
                    "MECH": ["Dr. J. Watt", "Prof. H. Ford", "Dr. R. Diesel"], 
                    "CIVIL": ["Prof. J. Smeaton", "Dr. E. Roebling", "Prof. F. Khan"] 
                },
                students: { 
                    "CSE": { 
                        "II": { "A": [
                                { "id": "161024733030", "name": "MA HANNAN MOHIUDDIN" }, { "id": "161024733031", "name": "MOHAMMED ARMAN AHMED QURESHI" }, { "id": "161024733032", "name": "MIRZA AMAN AHMED BAIG" }, { "id": "161024733033", "name": "MOHAMMED ABDUL ZAIN" }, { "id": "161024733034", "name": "MOHAMMED MOHIUDDIN" }, { "id": "161024733035", "name": "MOHAMMED FIRASAT ALI" }, { "id": "161024733036", "name": "AWAD BIN OSMAN NABHAN" }, { "id": "161024733037", "name": "SYED AQEEL" }, { "id": "161024733038", "name": "MOHAMMED SHEEZAN AKRAM" }, { "id": "161024733039", "name": "MOHAMMED HAMZA FAROOQUI" }, { "id": "161024733040", "name": "MOHAMMAD ABDUL JABBAR FARAZ" }, { "id": "161024733041", "name": "MOHAMMAD AMAAN" }, { "id": "161024733042", "name": "MOHAMMED KAMRAN KAIF" }, { "id": "161024733043", "name": "MOHAMMAD SIKANDER AYAZ" }, { "id": "161024733044", "name": "SYED AYAZ" }, { "id": "161024733045", "name": "MOHAMMED MAJAAZ AHMED" }, { "id": "161024733046", "name": "SYED TOUSEEF AHMED" }, { "id": "161024733047", "name": "MOHAMMED SULEMAN SHARIFF" }, { "id": "161024733048", "name": "MD FURKHAN ULLAH" }, { "id": "161024733049", "name": "SYED ZEESHAN MEHMOOD" }, { "id": "161024733050", "name": "MOHAMMED IBRAHIM" }, { "id": "161024733051", "name": "MOHAMMED RAYAN UDDIN" }, { "id": "161024733052", "name": "MOHAMMED AYAAN ALI AHMED" }, { "id": "161024733053", "name": "MD SOHAIL" }, { "id": "161024733054", "name": "MOHD ABDUL RIYAAN" }, { "id": "161024733055", "name": "MOHAMMED ZAHEER UDDIN" }, { "id": "161024733056", "name": "MOHAMMED QASIM ADNAN" }, { "id": "161024733057", "name": "AJMAL AHMED FAROOQUI" }, { "id": "161024733058", "name": "MOHD IRFAN" }, { "id": "161024733059", "name": "MOHAMMED ABDUL GHANI" }, { "id": "161024733060", "name": "MOHAMMED ANAS" }
                            ]
                        },
                        "III": { "A": Array.from({ length: 30 }, (_, i) => ({ id: `1610237330${30+i}`, name: `CSE III-A Student ${i+1}` })) }
                    } 
                },
                schedule: {},
                attendance: {},
                leaves: []
            };
            
            // Manually set the schedule for CSE II Year Section A
            data.schedule['CSE'] = data.schedule['CSE'] || {};
            data.schedule['CSE']['II'] = data.schedule['CSE']['II'] || {};
            data.schedule['CSE']['II']['A'] = {
                "Monday": [
                    { subject: "BE", faculty: "Ms. Maimoona Arshiya" },
                    { subject: "ETCE", faculty: "Ms. Saba Fatima" },
                    { subject: "OR", faculty: "Ms. Azeera Shaheen" },
                    null,
                    null, null, null
                ],
                "Tuesday": [
                    { subject: "BE", faculty: "Ms. Maimoona Arshiya" },
                    { subject: "DBMS", faculty: "Ms. Afsha Sultana" },
                    { subject: "DSP", faculty: "Mr. Mohd Anjum Shadani" },
                    { subject: "DM", faculty: "Ms. Imrana Begum" },
                    { subject: "DBMS LAB", faculty: "Ms. Afsha Sultana" },
                    null, null
                ],
                "Wednesday": [
                    { subject: "ETCE", faculty: "Ms. Saba Fatima" },
                    { subject: "DSP", faculty: "Mr. Mohd Anjum Shadani" },
                    { subject: "DBMS", faculty: "Ms. Afsha Sultana" },
                    { subject: "DM", faculty: "Ms. Imrana Begum" },
                    { subject: "DSP LAB", faculty: "Mr. Mohd Anjum Shadani" },
                    null, null
                ],
                "Thursday": [
                    { subject: "OR", faculty: "Ms. Azeera Shaheen" },
                    { subject: "DM", faculty: "Ms. Imrana Begum" },
                    { subject: "ETCE", faculty: "Ms. Saba Fatima" },
                    { subject: "DBMS", faculty: "Ms. Afsha Sultana" },
                    null, null, null
                ],
                "Friday": [
                    { subject: "BE LAB", faculty: "Ms. Maimoona Arshiya" },
                    { subject: "BE LAB", faculty: "Ms. Maimoona Arshiya" },
                    { subject: "DSP", faculty: "Mr. Mohd Anjum Shadani" },
                    { subject: "OR", faculty: "Ms. Azeera Shaheen" },
                    null, null, null
                ]
            };
            
            // Manually set the schedule for CSE III Year Section A
            data.schedule['CSE']['III'] = data.schedule['CSE']['III'] || {};
            data.schedule['CSE']['III']['A'] = {
                "Monday": [
                    { subject: "Effective Technical Communication in English", faculty: "Ms. Saba" },
                    { subject: "Basic Electronics", faculty: "Ms. Qudsia" },
                    null,
                    { subject: "Data Structures", faculty: "Ms. Tahera Abid" },
                    { subject: "Finance and Accounting", faculty: "Ms. Jameel Unisa" },
                    null,
                    { subject: "Library", faculty: "Librarian" }
                ],
                "Tuesday": [
                    { subject: "Effective Technical Communication in English", faculty: "Ms. Saba" },
                    { subject: "Python Programming", faculty: "Dr. Farheen Sultana" },
                    null,
                    { subject: "Basic Electronics", faculty: "Ms. Qudsia" },
                    { subject: "BE LAB/DS LAB", faculty: "Ms. Qudsia Kamal / Ms. Tahera Abid" },
                    { subject: "BE LAB/DS LAB", faculty: "Ms. Qudsia Kamal / Ms. Tahera Abid" },
                    null
                ],
                "Wednesday": [
                    { subject: "Finance and Accounting", faculty: "Ms. Jameel Unisa" },
                    null,
                    { subject: "Probability and Statistics", faculty: "Dr. Khasim Ali" },
                    null,
                    { subject: "PP LAB/DS LAB", faculty: "Dr. Farheen Sultana / Ms. Tahera Abid" },
                    { subject: "PP LAB/DS LAB", faculty: "Dr. Farheen Sultana / Ms. Tahera Abid" },
                    null
                ],
                "Thursday": [
                    { subject: "Finance and Accounting", faculty: "Ms. Jameel Unisa" },
                    { subject: "Effective Technical Communication in English", faculty: "Ms. Saba" },
                    { subject: "Probability and Statistics", faculty: "Dr. Khasim Ali" },
                    { subject: "Python Programming", faculty: "Dr. Farheen Sultana" },
                    { subject: "BE LAB/PP LAB", faculty: "Ms. Qudsia Kamal / Dr. Farheen Sultana" },
                    { subject: "BE LAB/PP LAB", faculty: "Ms. Qudsia Kamal / Dr. Farheen Sultana" },
                    null
                ],
                "Friday": [
                    { subject: "Data Structures", faculty: "Ms. Tahera Abid" },
                    { subject: "Indian Constitution", faculty: "Mr. Khader" },
                    null,
                    { subject: "Python Programming", faculty: "Dr. Farheen Sultana" },
                    { subject: "Data Structures", faculty: "Ms. Tahera Abid" },
                    null,
                    { subject: "SPORTS", faculty: "Sports Head" }
                ]
            };


            return data;
        }


        function generateSchedules() {
            timeTableData.departments.forEach(dept => {
                timeTableData.schedule[dept] = timeTableData.schedule[dept] || {};
                const deptFaculty = timeTableData.faculty[dept];
                timeTableData.years.forEach(year => {
                    timeTableData.schedule[dept][year] = timeTableData.schedule[dept][year] || {};
                    const yearSubjects = timeTableData.subjects[year];
                    timeTableData.sections.forEach(section => {
                        // Skip classes with manually set data
                        if ((dept === 'CSE' && year === 'II' && section === 'A') || (dept === 'CSE' && year === 'III' && section === 'A')) {
                            return;
                        }
                        if (!timeTableData.students[dept]?.[year]?.[section]) {
                            if (!timeTableData.students[dept]) timeTableData.students[dept] = {};
                            if (!timeTableData.students[dept][year]) timeTableData.students[dept][year] = {};
                            timeTableData.students[dept][year][section] = Array.from({ length: 30 }, (_, i) => ({ id: `${dept.slice(0,2)}${year.length}${section}${100+i}`, name: `${dept} Student ${year}-${section}-${i+1}` }));
                        }
                        if (!timeTableData.schedule[dept]?.[year]?.[section] || Object.keys(timeTableData.schedule[dept][year][section]).length === 0) {
                            timeTableData.schedule[dept][year][section] = {};
                            days.forEach(day => {
                                timeTableData.schedule[dept][year][section][day] = [];
                                for (let i = 0; i < (timeTableData.timeSlots || []).length; i++) {
                                    const subject = yearSubjects[(i + days.indexOf(day) + timeTableData.sections.indexOf(section)) % yearSubjects.length];
                                    const faculty = deptFaculty && deptFaculty.length > 0 ? deptFaculty[(i + days.indexOf(day)) % deptFaculty.length] : 'N/A';
                                    timeTableData.schedule[dept][year][section][day].push({ subject, faculty });
                                }
                            });
                        }
                    });
                });
            });
            saveData();
        }

        // --- SCRIPT EXECUTION STARTS HERE ---
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM ELEMENT VARIABLES (DECLARED AFTER DOM IS READY) ---
            const landingPage = document.getElementById('landing-page');
            const appContainer = document.getElementById('app');
            const roleSelectionView = document.getElementById('role-selection-view');
            const mainView = document.getElementById('main-view');
            const viewTitle = document.getElementById('view-title');
            const filtersContainer = document.getElementById('filters');
            const timetableContainer = document.getElementById('timetable-container');
            const studentAttendanceSummary = document.getElementById('student-attendance-summary');
            const facultyCurrentClassView = document.getElementById('faculty-current-class-view');
            const backButton = document.getElementById('back-button');
            const manageFacultyBtn = document.getElementById('manage-faculty-btn');
            const manageStudentsBtn = document.getElementById('manage-students-btn');
            const manageTimeSlotsBtn = document.getElementById('manage-time-slots-btn');
            const viewAttendanceReportBtn = document.getElementById('view-attendance-report-btn');
            const geminiResult = document.getElementById('gemini-result');
            const facultyActions = document.getElementById('faculty-actions');
            const viewLeaveRequestsBtn = document.getElementById('view-leave-requests-btn');
            let draggedElement = null;

            // --- LANDING PAGE LOGIC ---
            const revealElements = document.querySelectorAll('.reveal');
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('visible');
                    }
                });
            }, { threshold: 0.1 });

            revealElements.forEach(el => observer.observe(el));

            const launchApp = () => {
                landingPage.style.transition = 'opacity 0.5s ease-out';
                landingPage.style.opacity = '0';
                setTimeout(() => {
                    landingPage.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    appContainer.style.opacity = '0';
                    setTimeout(() => {
                        appContainer.style.transition = 'opacity 0.5s ease-in';
                        appContainer.style.opacity = '1';
                    }, 50);
                }, 500);
            };

            document.getElementById('launch-app-btn-nav').addEventListener('click', launchApp);
            document.getElementById('launch-app-btn-hero').addEventListener('click', launchApp);
            
            const goBackToLanding = () => {
                appContainer.style.transition = 'opacity 0.5s ease-out';
                appContainer.style.opacity = '0';
                setTimeout(() => {
                    appContainer.classList.add('hidden');
                    landingPage.classList.remove('hidden');
                    landingPage.style.opacity = '0';
                    setTimeout(() => {
                        landingPage.style.transition = 'opacity 0.5s ease-in';
                        landingPage.style.opacity = '1';
                    }, 50);
                }, 500);
            };
            document.getElementById('back-to-landing-btn').addEventListener('click', goBackToLanding);
            
            document.getElementById('feedback-form').addEventListener('submit', (e) => {
                e.preventDefault();
                e.target.classList.add('hidden');
                document.getElementById('feedback-success').classList.remove('hidden');
            });


            // --- CORE APP LOGIC ---
            loadData();

            // --- PASSWORD TOGGLE LOGIC ---
            const eyeIconSVG = `<svg class="w-5 h-5 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>`;
            const eyeOffIconSVG = `<svg class="w-5 h-5 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path></svg>`;

            function setupPasswordToggle(toggleButton, passwordInput) {
                if (toggleButton && passwordInput) {
                    toggleButton.innerHTML = eyeOffIconSVG; // Start with password hidden
                    toggleButton.style.transition = 'opacity 0.2s ease, transform 0.2s ease';

                    toggleButton.addEventListener('click', () => {
                        const isPassword = passwordInput.type === 'password';
                        
                        // Fade out with a little spin
                        toggleButton.style.opacity = '0';
                        toggleButton.style.transform = 'scale(0.7) rotate(-90deg)';

                        setTimeout(() => {
                            passwordInput.type = isPassword ? 'text' : 'password';
                            toggleButton.innerHTML = isPassword ? eyeIconSVG : eyeOffIconSVG;
                            // Fade in, spinning back
                            toggleButton.style.opacity = '1';
                            toggleButton.style.transform = 'scale(1) rotate(0deg)';
                        }, 200);
                    });
                }
            }

            setupPasswordToggle(
                document.getElementById('toggle-hod-password'), 
                document.getElementById('password')
            );
            setupPasswordToggle(
                document.getElementById('toggle-faculty-password'),
                document.getElementById('faculty-password')
            );

            function switchView(view) {
                if (view === 'main') {
                    roleSelectionView.classList.add('hidden');
                    mainView.classList.remove('hidden');
                } else {
                    mainView.classList.add('hidden');
                    roleSelectionView.classList.remove('hidden');
                }
            }

            backButton.addEventListener('click', () => {
                currentRole = null;
                currentFacultyName = null;
                facultyCurrentClassView.classList.add('hidden');
                facultyActions.classList.add('hidden');
                manageFacultyBtn.classList.add('hidden');
                manageStudentsBtn.classList.add('hidden');
                manageTimeSlotsBtn.classList.add('hidden');
                viewLeaveRequestsBtn.classList.add('hidden');
                studentAttendanceSummary.classList.add('hidden');
                viewAttendanceReportBtn.classList.add('hidden');
                document.getElementById('analyze-workload-btn').classList.add('hidden');
                const aiTutorContainer = mainView.querySelector('.ai-tutor-container');
                if(aiTutorContainer) aiTutorContainer.remove();
                const helper = document.getElementById('hod-helper-text');
                if (helper) helper.remove();
                switchView('roles');
            });
            
            document.getElementById('select-student').addEventListener('click', () => {
                const deptSelect = createSelect('s-dept', 'Dept', timeTableData.departments, document.getElementById('student-dept-select-container'));
                const yearSelect = createSelect('s-year', 'Year', timeTableData.years, document.getElementById('student-year-select-container'));
                const sectionSelect = createSelect('s-section', 'Section', timeTableData.sections, document.getElementById('student-section-select-container'));
                const nameSelect = document.getElementById('student-name-select');
                const submitBtn = document.getElementById('student-login-submit-btn');

                function updateStudentList() {
                    const [dept, year, section] = [deptSelect.value, yearSelect.value, sectionSelect.value];
                    if (dept && year && section) {
                        const students = timeTableData.students[dept]?.[year]?.[section] || [];
                        const studentOptions = students.map(s => ({ value: s.id, text: s.name }));
                        updateSelectOptions(nameSelect, studentOptions, 'Select your name...');
                        nameSelect.disabled = students.length === 0;
                        document.getElementById('student-name-select-container').classList.remove('hidden');
                    } else {
                        updateSelectOptions(nameSelect, [], 'Select class first...', '');
                        nameSelect.disabled = true;
                    }
                    submitBtn.disabled = !nameSelect.value;
                }

                [deptSelect, yearSelect, sectionSelect].forEach(sel => sel.addEventListener('change', updateStudentList));
                nameSelect.addEventListener('change', () => { submitBtn.disabled = !nameSelect.value; });
                
                toggleModal('student-login-modal', true);
            });
        
            document.getElementById('select-faculty').addEventListener('click', () => {
                updateSelectOptions(document.getElementById('faculty-username'), Object.values(timeTableData.faculty).flat().sort(), 'Select your name...', '');
                toggleModal('faculty-login-modal', true);
            });
            document.getElementById('select-hod').addEventListener('click', () => {
                toggleModal('hod-login-modal', true);
            });

            document.addEventListener('click', (e) => {
                const closeButton = e.target.closest('[data-close-modal]');
                if (closeButton) {
                    const modal = closeButton.closest('.modal');
                    if (modal) {
                        modal.classList.add('hidden');
                    }
                }
            });

            document.getElementById('hod-login-form').addEventListener('submit', (e) => {
                e.preventDefault();
                if (e.target.username.value === 'hod' && e.target.password.value === 'HOD123') {
                    toggleModal('hod-login-modal', false);
                    setupHODView();
                } else {
                    const errorEl = document.getElementById('login-error');
                    errorEl.textContent = 'Invalid credentials.';
                    errorEl.classList.remove('hidden');
                }
            });

            document.getElementById('faculty-login-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const facultyName = e.target['faculty-username'].value;
                const password = e.target['faculty-password'].value;
                if (facultyName && password === 'faculty123') {
                    toggleModal('faculty-login-modal', false);
                    setupFacultyView(facultyName);
                } else {
                    const errorEl = document.getElementById('faculty-login-error');
                    errorEl.textContent = 'Invalid credentials.';
                    errorEl.classList.remove('hidden');
                }
            });

            document.getElementById('student-login-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const dept = document.getElementById('s-dept').value;
                const year = document.getElementById('s-year').value;
                const section = document.getElementById('s-section').value;
                const studentId = document.getElementById('student-name-select').value;
                if (!studentId) return;

                const studentName = timeTableData.students[dept]?.[year]?.[section]?.find(s => s.id === studentId)?.name || 'Student';
                
                toggleModal('student-login-modal', false);
                setupStudentView({ dept, year, section, id: studentId, name: studentName });
            });
            
            function createSelect(id, label, options, container) { container.innerHTML = `<label for="${id}" class="block text-sm font-medium text-slate-700 mb-1">${label}</label><select id="${id}" class="block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500"><option value="">Select ${label}...</option>${options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}</select>`; return container.querySelector('select'); }
            function updateSelectOptions(select, options, placeholder, currentValue = '') { select.innerHTML = `<option value="">${placeholder}</option>${options.map(opt => `<option value="${opt.value || opt}" ${ (opt.value || opt) === currentValue ? 'selected' : ''}>${opt.text || opt}</option>`).join('')}`; }
            function getTodayDateString() { const today = new Date(); return `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`; }
            function getCurrentTimeInfo() {
                const now = new Date();
                const dayIndex = now.getDay() - 1; // Monday = 0, Sunday = 6
                const currentDay = days[dayIndex];
                const currentTime = now.getHours() + (now.getMinutes() / 60);
                let currentSlotIndex = -1;

                if (dayIndex >= 0 && dayIndex < 5) { // Check if it's a weekday
                    // Map current time to slot index
                    if (currentTime >= 9 && currentTime < 10) currentSlotIndex = 0;
                    else if (currentTime >= 10 && currentTime < 11) currentSlotIndex = 1;
                    else if (currentTime >= 11 && currentTime < 12) currentSlotIndex = 2;
                    else if (currentTime >= 12 && currentTime < 13) currentSlotIndex = 3;
                    // Lunch break is from 1 to 2
                    else if (currentTime >= 14 && currentTime < 15) currentSlotIndex = 4;
                    else if (currentTime >= 15 && currentTime < 16) currentSlotIndex = 5;
                    else if (currentTime >= 16 && currentTime < 17) currentSlotIndex = 6;
                }
                
                return { currentDay, currentSlotIndex };
            }
            
            function renderTimetable(data, highlight = {}) {
                if (!data) { timetableContainer.innerHTML = `<p class="text-center text-slate-500 py-8">Please make a selection to view the timetable.</p>`; return; }
                timetableContainer.classList.toggle('editable', currentRole === 'hod');
                let table = `<table class="w-full min-w-[700px] border-collapse text-center"><thead><tr class="bg-red-100"><th class="p-3 font-semibold border border-slate-300">Time</th>${days.map(day => `<th class="p-3 font-semibold border border-slate-300">${day}</th>`).join('')}</tr></thead><tbody>`;
                (timeTableData.timeSlots || []).forEach((slot, i) => {
                    if(i === 4) { // LUNCH BREAK after 4th period (12:00-1:00)
                        table += `<tr class="bg-slate-100"><td colspan="6" class="p-2 font-bold text-slate-600 border border-slate-300 text-center">L U N C H</td></tr>`;
                    }
                    table += `<tr class="bg-white"><td class="p-2 font-medium text-slate-600 border border-slate-300">${slot}</td>`;
                    days.forEach(day => {
                        const period = data[day]?.[i];
                        const content = period ? `<div class="font-semibold">${period.subject}</div><div class="text-sm text-slate-500">${period.faculty}</div>` : '-';
                        const isCurrent = (day === highlight.day && i === highlight.slotIndex);
                        let hodAttrs = '';
                        let cellClass = '';
                        if (currentRole === 'hod') {
                            hodAttrs = `data-day="${day}" data-slot-index="${i}"`;
                            if (period) {
                                hodAttrs += ` draggable="true"`;
                                cellClass = 'cursor-grab';
                            }
                        }
                        table += `<td class="p-2 border border-slate-300 smooth-transition ${cellClass} ${isCurrent ? 'current-class' : ''}" ${hodAttrs}>${content}</td>`;
                    });
                    table += `</tr>`;
                });
                table += '</tbody></table>';
                timetableContainer.innerHTML = table;
                if (currentRole === 'hod') {
                    const cells = document.querySelectorAll('#timetable-container td[data-day]');
                    cells.forEach(cell => {
                        cell.addEventListener('click', () => {
                            const dept = document.getElementById('h-dept').value;
                            const year = document.getElementById('h-year').value;
                            const section = document.getElementById('h-section').value;
                            if (timeTableData.schedule[dept]?.[year]?.[section]?.[cell.dataset.day]?.[cell.dataset.slotIndex]) {
                                openEditModal(cell.dataset.day, cell.dataset.slotIndex);
                            }
                        });
                        cell.addEventListener('dragover', handleDragOver);
                        cell.addEventListener('dragenter', handleDragEnter);
                        cell.addEventListener('dragleave', handleDragLeave);
                        cell.addEventListener('drop', handleDrop);
                        if (cell.draggable) {
                            cell.addEventListener('dragstart', handleDragStart);
                        }
                    });
                }
            }

            
            function setupStudentView(studentInfo) {
                currentRole = 'student';
                viewTitle.textContent = `Dashboard for ${studentInfo.name}`;
                filtersContainer.innerHTML = '';
                timetableContainer.innerHTML = '';
                switchView('main');
                const { dept, year, section } = studentInfo;

                const aiTutorContainer = document.createElement('div');
                aiTutorContainer.className = 'ai-tutor-container my-6 p-4 bg-purple-50 border-l-4 border-purple-500 rounded-r-lg flex flex-wrap justify-between items-center gap-4';
                
                let buttonsHTML = `
                    <button id="ask-ai-tutor-btn" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg smooth-transition whitespace-nowrap">✨ Ask a Doubt</button>
                    <button id="create-study-plan-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg smooth-transition whitespace-nowrap">✨ Create Study Plan</button>
                `;
                
                if (year === 'III' || year === 'IV') {
                    buttonsHTML += `<button id="generate-project-ideas-btn" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg smooth-transition whitespace-nowrap">✨ Project Ideas</button>`;
                }

                aiTutorContainer.innerHTML = `
                    <div>
                        <h4 class="font-bold text-purple-800">Your Personal AI Assistant</h4>
                        <p class="text-purple-700 text-sm">Stuck on a concept or need help planning your studies? I can help!</p>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-2">
                        ${buttonsHTML}
                    </div>
                `;
                mainView.querySelector('.max-w-7xl').insertBefore(aiTutorContainer, studentAttendanceSummary);
                document.getElementById('ask-ai-tutor-btn').addEventListener('click', () => openAskDoubtModal(studentInfo));
                document.getElementById('create-study-plan-btn').addEventListener('click', () => handleCreateStudyPlan(studentInfo));
                if (document.getElementById('generate-project-ideas-btn')) {
                    document.getElementById('generate-project-ideas-btn').addEventListener('click', () => openProjectIdeaModal(studentInfo));
                }

                const scheduleForClass = timeTableData.schedule?.[dept]?.[year]?.[section];
                if (scheduleForClass) {
                    renderTimetable(scheduleForClass, getCurrentTimeInfo());
                    displayStudentAttendance(studentInfo);
                } else {
                    console.error(`Error: Timetable data not found for ${dept} ${year}-${section}.`);
                    timetableContainer.innerHTML = `<p class="text-center text-red-600 font-semibold p-8">Could not load the timetable for this class. Please contact the administrator.</p>`;
                    studentAttendanceSummary.innerHTML = '';
                    studentAttendanceSummary.classList.add('hidden');
                }
            }

            function setupFacultyView(facultyName) { currentRole = 'faculty'; currentFacultyName = facultyName; viewTitle.textContent = `Schedule for ${facultyName}`; facultyActions.classList.remove('hidden'); filtersContainer.innerHTML = ''; timetableContainer.innerHTML = ''; switchView('main'); displayFacultySchedule(facultyName); }
            
            function setupHODView() { 
                currentRole = 'hod'; 
                viewTitle.textContent = "HOD Dashboard"; 
                manageFacultyBtn.classList.remove('hidden'); 
                manageStudentsBtn.classList.remove('hidden');
                manageTimeSlotsBtn.classList.remove('hidden');
                viewLeaveRequestsBtn.classList.remove('hidden');
                document.getElementById('analyze-workload-btn').classList.remove('hidden');
                filtersContainer.innerHTML = ''; 
                timetableContainer.innerHTML = ''; 
                switchView('main'); 
                createHODFilters();
                const helperText = document.createElement('div');
                helperText.id = 'hod-helper-text';
                helperText.className = 'my-4 p-3 bg-blue-50 text-blue-800 border-l-4 border-blue-500 rounded-r-lg text-sm';
                helperText.innerHTML = `<b>Pro Tip:</b> You can click a class to edit its subject/faculty, or <b>drag and drop</b> a class to a new time or day.`;
                filtersContainer.parentNode.insertBefore(helperText, timetableContainer);
            }

            function createHODFilters() {
                const deptContainer = document.createElement('div');
                const yearContainer = document.createElement('div');
                const sectionContainer = document.createElement('div');
                const aiButtonContainer = document.createElement('div');
                aiButtonContainer.innerHTML = `<label class="block text-sm font-medium text-slate-700 mb-1 opacity-0">AI</label><button id="auto-generate-schedule-btn" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg smooth-transition disabled:bg-purple-300" disabled>✨ Auto-Generate</button>`;

                const deptSelect = createSelect('h-dept', 'Department', timeTableData.departments, deptContainer);
                const yearSelect = createSelect('h-year', 'Year', timeTableData.years, yearContainer);
                const sectionSelect = createSelect('h-section', 'Section', timeTableData.sections, sectionContainer);
                filtersContainer.innerHTML = '';
                filtersContainer.append(deptContainer, yearContainer, sectionContainer, aiButtonContainer);

                const autoGenerateBtn = document.getElementById('auto-generate-schedule-btn');
                const analyzeWorkloadBtn = document.getElementById('analyze-workload-btn');
                analyzeWorkloadBtn.disabled = true;

                autoGenerateBtn.addEventListener('click', handleAutoGenerateSchedule);
                analyzeWorkloadBtn.addEventListener('click', () => {
                    const dept = deptSelect.value;
                    if (dept) handleWorkloadAnalysis(dept);
                });
                
                const update = () => { 
                    const [dept, year, section] = [deptSelect.value, yearSelect.value, sectionSelect.value]; 
                    const selectionComplete = dept && year && section; 
                    viewAttendanceReportBtn.classList.toggle('hidden', !selectionComplete); 
                    autoGenerateBtn.disabled = !selectionComplete; 
                    analyzeWorkloadBtn.disabled = !dept;
                    if (selectionComplete) { renderTimetable(timeTableData.schedule[dept][year][section], getCurrentTimeInfo()); } else { timetableContainer.innerHTML = ''; }
                };
                [deptSelect, yearSelect, sectionSelect].forEach(sel => sel.addEventListener('change', update));
                update();
            }
            function displayFacultySchedule(facultyName) {
                const facultySchedule = {}; let currentClassDetails = null; const { currentDay, currentSlotIndex } = getCurrentTimeInfo();
                days.forEach(day => { facultySchedule[day] = Array((timeTableData.timeSlots || []).length).fill(null); timeTableData.departments.forEach(dept => { timeTableData.years.forEach(year => { timeTableData.sections.forEach(section => { const daySchedule = timeTableData.schedule[dept]?.[year]?.[section]?.[day]; if (daySchedule) { const period = daySchedule[currentSlotIndex]; if (day === currentDay && period?.faculty === facultyName) { currentClassDetails = { subject: period.subject, dept, year, section, day: currentDay, slotIndex: currentSlotIndex }; } daySchedule.forEach((p, i) => { if (p && p.faculty === facultyName) { facultySchedule[day][i] = { subject: p.subject, faculty: `${dept}-${year}-${section}` }; } }); } }); }); }); });
                if (currentClassDetails) {
                    facultyCurrentClassView.innerHTML = `<div class="text-center md:text-left flex-grow"><p class="font-bold">You have a class right now!</p><p>${currentClassDetails.subject} for ${currentClassDetails.dept}-${currentClassDetails.year}-${currentClassDetails.section}</p></div>
                    <div class="flex flex-wrap gap-2 justify-center">
                        <button id="ai-attendance-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg smooth-transition animate-pulse">✨ Take Attendance with AI Camera</button>
                        <button id="manual-attendance-btn" class="bg-slate-500 hover:bg-slate-600 text-white font-semibold py-2 px-4 rounded-lg smooth-transition">Take Attendance Manually</button>
                    </div>`;
                    document.getElementById('ai-attendance-btn').addEventListener('click', () => openAIAttendanceModal(currentClassDetails));
                    document.getElementById('manual-attendance-btn').addEventListener('click', () => openAttendanceModal(currentClassDetails));
                } else {
                    facultyCurrentClassView.innerHTML = `<div class="text-center w-full"><p class="font-bold">No class scheduled at this time.</p><p class="text-sm text-gray-600 mt-1">When your class starts, the attendance buttons will appear here.</p></div>`;
                }
                facultyCurrentClassView.classList.remove('hidden');
                renderTimetable(facultySchedule, { day: currentDay, slotIndex: currentSlotIndex });
            }
            function displayStudentAttendance(studentInfo) {
                const { dept, year, section, id: studentId } = studentInfo; const subjects = timeTableData.subjects[year]; let summaryHTML = `<h3 class="text-xl font-bold mb-4">Your Attendance Summary</h3><div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">`;
                subjects.forEach(subject => { let totalClasses = 0; let attendedClasses = 0; Object.keys(timeTableData.attendance).forEach(date => { Object.keys(timeTableData.attendance[date]).forEach(slotIndex => { const classSchedule = timeTableData.schedule?.[dept]?.[year]?.[section]?.[days[new Date(date).getDay() - 1]]?.[slotIndex]; if (classSchedule?.subject === subject) { const classKey = `${dept}-${year}-${section}`; const record = timeTableData.attendance[date][slotIndex]?.[classKey]; if (record) { totalClasses++; if (record[studentId] === 'present') { attendedClasses++; } } } }); });
                const percentage = totalClasses > 0 ? ((attendedClasses / totalClasses) * 100).toFixed(1) : "100.0"; const color = percentage >= 75 ? 'text-green-600' : 'text-red-600'; summaryHTML += `<div class="p-3 bg-white rounded-lg border flex flex-col justify-between shadow-sm hover:shadow-md smooth-transition"><div class="mb-2"><p class="font-semibold">${subject}</p><p class="text-2xl font-bold ${color}">${percentage}%</p><p class="text-sm text-slate-500">(${attendedClasses}/${totalClasses} classes)</p></div><button class="get-study-tips-btn text-xs bg-purple-100 text-purple-800 font-semibold py-1 px-2 rounded-full hover:bg-purple-200 smooth-transition w-full" data-subject="${subject}">✨ Get Study Tips</button></div>`; });
                summaryHTML += `</div>`; studentAttendanceSummary.innerHTML = summaryHTML; studentAttendanceSummary.classList.remove('hidden');
                document.querySelectorAll('.get-study-tips-btn').forEach(btn => btn.addEventListener('click', (e) => handleGetStudyTips(e.target.dataset.subject)));
            }
            function openAttendanceModal(classInfo, prefilledRecord = null) {
                currentClassInfoForAttendance = classInfo; const { dept, year, section, subject } = classInfo; const students = timeTableData.students[dept]?.[year]?.[section] || []; document.getElementById('attendance-modal-title').textContent = `Attendance for ${subject}`; document.getElementById('attendance-modal-subtitle').textContent = `Class: ${dept} - ${year} ${section} | Date: ${getTodayDateString()}`; document.getElementById('student-count').textContent = students.length; const studentListContainer = document.getElementById('student-list-container'); studentListContainer.innerHTML = ''; const today = getTodayDateString(); const existingRecord = prefilledRecord || timeTableData.attendance?.[today]?.[classInfo.slotIndex]?.[`${dept}-${year}-${section}`] || {};
                students.forEach(student => { const status = existingRecord[student.id] || (prefilledRecord ? 'absent' : 'present'); const row = document.createElement('div'); row.className = 'flex justify-between items-center p-2 rounded-lg hover:bg-slate-50'; row.innerHTML = `<div><p class="font-medium">${student.name}</p><p class="text-xs text-slate-500">${student.id}</p></div><div class="attendance-toggle" data-studentid="${student.id}"><button type="button" class="present ${status === 'present' ? 'active' : ''}" data-status="present">P</button><button type="button" class="absent ${status === 'absent' ? 'active' : ''}" data-status="absent">A</button></div>`; studentListContainer.appendChild(row); });
                toggleModal('attendance-modal', true);
            }
            document.getElementById('student-list-container').addEventListener('click', (e) => { if (e.target.tagName === 'BUTTON') { const parent = e.target.parentElement; parent.querySelector('.active').classList.remove('active'); e.target.classList.add('active'); }});
            document.getElementById('mark-all-present-btn').addEventListener('click', () => { document.querySelectorAll('.attendance-toggle').forEach(toggle => { toggle.querySelector('.absent').classList.remove('active'); toggle.querySelector('.present').classList.add('active'); }); });
            document.getElementById('attendance-form').addEventListener('submit', (e) => { e.preventDefault(); const { dept, year, section, slotIndex } = currentClassInfoForAttendance; const today = getTodayDateString(); if (!timeTableData.attendance[today]) timeTableData.attendance[today] = {}; if (!timeTableData.attendance[today][slotIndex]) timeTableData.attendance[today][slotIndex] = {}; const classKey = `${dept}-${year}-${section}`; const record = {}; document.querySelectorAll('.attendance-toggle').forEach(toggle => { record[toggle.dataset.studentid] = toggle.querySelector('.active').dataset.status; }); timeTableData.attendance[today][slotIndex][classKey] = record; saveData(); toggleModal('attendance-modal', false); });
            viewAttendanceReportBtn.addEventListener('click', () => { document.getElementById('report-date').value = getTodayDateString(); renderAttendanceReport(); toggleModal('attendance-report-modal', true); });
            document.getElementById('report-date').addEventListener('change', renderAttendanceReport);
            document.getElementById('get-attendance-insights-btn').addEventListener('click', handleGetAttendanceInsights);
            function renderAttendanceReport() {
                const [dept, year, section] = [document.getElementById('h-dept').value, document.getElementById('h-year').value, document.getElementById('h-section').value]; const date = document.getElementById('report-date').value; if(!dept || !year || !section) return;
                document.getElementById('report-modal-title').textContent = `Attendance Report for ${dept}-${year}-${section} on ${date}`; const students = timeTableData.students[dept]?.[year]?.[section] || []; const container = document.getElementById('report-container'); let table = `<table class="w-full border-collapse text-left"><thead><tr class="bg-slate-200"><th class="p-2 border border-slate-300">Student ID</th><th class="p-2 border border-slate-300">Student Name</th>`;
                (timeTableData.timeSlots || []).forEach(slot => { table += `<th class="p-2 border border-slate-300 text-center">${slot}</th>`; }); table += `</tr></thead><tbody>`;
                students.forEach(student => { table += `<tr class="bg-white hover:bg-slate-50"><td class="p-2 border border-slate-300 text-sm">${student.id}</td><td class="p-2 border border-slate-300 font-medium">${student.name}</td>`; (timeTableData.timeSlots || []).forEach((slot, i) => { const record = timeTableData.attendance?.[date]?.[i]?.[`${dept}-${year}-${section}`]?.[student.id]; let status = '-'; if (record === 'present') status = `<span class="font-bold text-green-600">P</span>`; if (record === 'absent') status = `<span class="font-bold text-red-600">A</span>`; table += `<td class="p-2 border border-slate-300 text-center">${status}</td>`; }); table += `</tr>`; });
                container.innerHTML = table + `</tbody></table>`;
            }
            function openEditModal(day, slotIndex) {
                const [dept, year, section] = [document.getElementById('h-dept').value, document.getElementById('h-year').value, document.getElementById('h-section').value]; if (!dept || !year || !section) return;
                const currentSlot = timeTableData.schedule[dept][year][section][day][slotIndex]; document.getElementById('edit-modal-title').textContent = `Update Slot: ${day} (${(timeTableData.timeSlots || [])[slotIndex]})`; document.getElementById('edit-day').value = day; document.getElementById('edit-slot-index').value = slotIndex;
                updateSelectOptions(document.getElementById('subject-select'), timeTableData.subjects[year], 'Select Subject...', currentSlot?.subject);
                updateSelectOptions(document.getElementById('faculty-select-modal'), timeTableData.faculty[dept], 'Select Faculty...', currentSlot?.faculty);
                toggleModal('edit-slot-modal', true);
            }
            document.getElementById('edit-slot-form').addEventListener('submit', (e) => { e.preventDefault(); const [dept, year, section] = [document.getElementById('h-dept').value, document.getElementById('h-year').value, document.getElementById('h-section').value]; const day = document.getElementById('edit-day').value; const slotIndex = parseInt(document.getElementById('edit-slot-index').value); timeTableData.schedule[dept][year][section][day][slotIndex] = { subject: document.getElementById('subject-select').value, faculty: document.getElementById('faculty-select-modal').value }; saveData(); toggleModal('edit-slot-modal', false); renderTimetable(timeTableData.schedule[dept][year][section]); });
            manageFacultyBtn.addEventListener('click', () => { const dept = document.getElementById('h-dept').value; if (!dept) { alert("Please select a Department first."); return; } document.getElementById('manage-faculty-title').textContent = `Manage ${dept} Faculty`; renderFacultyList(dept); toggleModal('manage-faculty-modal', true); });
            function renderFacultyList(dept) { const container = document.getElementById('faculty-list'); container.innerHTML = ''; const currentFaculty = timeTableData.faculty[dept] || []; if (currentFaculty.length === 0) { container.innerHTML = `<p class="text-slate-500 text-center">No faculty members found.</p>`; } else { currentFaculty.forEach(name => { const div = document.createElement('div'); div.className = 'flex justify-between items-center p-2 border-b'; div.innerHTML = `<span>${name}</span><button data-name="${name}" class="remove-faculty-btn text-red-500 hover:text-red-700 font-semibold text-sm">Remove</button>`; container.appendChild(div); }); } document.querySelectorAll('.remove-faculty-btn').forEach(btn => { btn.addEventListener('click', (e) => removeFaculty(dept, e.target.dataset.name)); }); }
            function removeFaculty(dept, name) { timeTableData.faculty[dept] = timeTableData.faculty[dept].filter(f => f !== name); saveData(); renderFacultyList(dept); }
            document.getElementById('add-faculty-form').addEventListener('submit', (e) => { e.preventDefault(); const dept = document.getElementById('h-dept').value; const newNameInput = document.getElementById('new-faculty-name'); const newName = newNameInput.value.trim(); const errorEl = document.getElementById('faculty-error'); if (newName && !(timeTableData.faculty[dept] || []).includes(newName)) { if(!timeTableData.faculty[dept]) timeTableData.faculty[dept] = []; timeTableData.faculty[dept].push(newName); timeTableData.faculty[dept].sort(); saveData(); renderFacultyList(dept); newNameInput.value = ''; errorEl.classList.add('hidden'); } else if ((timeTableData.faculty[dept] || []).includes(newName)) { errorEl.textContent = 'This faculty member already exists.'; errorEl.classList.remove('hidden'); } });
            function openAskDoubtModal(studentInfo) {
                const { year } = studentInfo;
                const subjects = timeTableData.subjects[year] || [];
                const subjectSelect = document.getElementById('doubt-subject-select');
                updateSelectOptions(subjectSelect, subjects, 'Select a subject...');
                document.getElementById('doubt-textarea').value = '';
                toggleModal('ask-doubt-modal', true);
            }
            document.getElementById('ask-doubt-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const subject = document.getElementById('doubt-subject-select').value;
                const question = document.getElementById('doubt-textarea').value;
                if (!subject || !question) return;
                toggleModal('ask-doubt-modal', false);
                document.getElementById('gemini-modal-title').textContent = `✨ AI Tutor Explains: ${subject}`;
                const prompt = `You are a friendly and encouraging engineering tutor. An undergraduate student has a question about the subject "${subject}".
                Student's question: "${question}"
                Please provide a clear, step-by-step explanation. Use simple language, and if appropriate, give a small example or an analogy to help them understand. Keep the tone supportive.`;
                const result = await callGeminiAPI(prompt);
                if (result) { geminiResult.innerHTML = result.replace(/\n/g, '<br>'); }
            });

            // --- LEAVE MANAGEMENT ---
            document.getElementById('take-leave-btn').addEventListener('click', () => {
                const leaveDateInput = document.getElementById('leave-date');
                leaveDateInput.value = getTodayDateString();
                leaveDateInput.min = getTodayDateString();
                document.getElementById('leave-reason').value = '';
                toggleModal('take-leave-modal', true);
            });
            document.getElementById('my-leave-status-btn').addEventListener('click', () => { renderFacultyLeaveStatus(); toggleModal('view-leaves-modal', true); });
            document.getElementById('draft-leave-reason-btn').addEventListener('click', async (e) => { const reasonTextarea = document.getElementById('leave-reason'); const reason = reasonTextarea.value.trim(); if (!reason) { alert("Please provide a brief reason first."); return; } const draftBtn = e.target; const originalText = draftBtn.innerHTML; draftBtn.innerHTML = `<span class="loader" style="width:16px; height:16px; border-width:2px; border-top-color:#8b5cf6;"></span>`; draftBtn.disabled = true; const prompt = `You are a professional assistant. A faculty member, ${currentFacultyName}, needs to write a leave request. Their brief reason is: "${reason}". Please expand this into a polite, professional, one-paragraph message suitable for an email to the Head of Department. Start with "Respected HOD,".`; const result = await getGeminiTextOnly(prompt); reasonTextarea.value = result; draftBtn.innerHTML = originalText; draftBtn.disabled = false; });
            document.getElementById('take-leave-form').addEventListener('submit', async (e) => { 
                e.preventDefault(); 
                const leaveDate = document.getElementById('leave-date').value; 
                const leaveReason = document.getElementById('leave-reason').value; 
                timeTableData.leaves.push({ faculty: currentFacultyName, date: leaveDate, reason: leaveReason, status: 'pending', rejectionReason: '' }); 
                saveData(); 
                toggleModal('take-leave-modal', false); 
                
                document.getElementById('gemini-modal-title').textContent = '✅ Leave Request Submitted';
                const confirmationHTML = `<p class="text-lg">Your leave request has been successfully submitted for review.</p>`;
                geminiResult.innerHTML = confirmationHTML + `<div id="substitute-suggestion" class="mt-4 pt-4 border-t"><div class="loader mx-auto"></div><p class="text-center text-slate-500 mt-2">Checking for potential substitute arrangements...</p></div>`;
                toggleModal('gemini-modal', true);

                const substituteSuggestion = await handleFindSubstitute(currentFacultyName, leaveDate);
                document.getElementById('substitute-suggestion').innerHTML = substituteSuggestion;
            });
            viewLeaveRequestsBtn.addEventListener('click', () => { renderLeaveRequests(); toggleModal('view-leaves-modal', true); });
            function getStatusStyles(status) { switch (status) { case 'approved': return { bg: 'bg-green-100', text: 'text-green-800' }; case 'rejected': return { bg: 'bg-red-100', text: 'text-red-800' }; case 'pending': default: return { bg: 'bg-yellow-100', text: 'text-yellow-800' }; } }
            function handleLeaveAction(event) {
                const index = event.target.dataset.leaveIndex;
                const action = event.target.dataset.action;
                if (index !== undefined && timeTableData.leaves[index]) {
                    if (action === 'approved') {
                        initiateAIRescheduling(timeTableData.leaves[index], index);
                    } else if (action === 'rejected') {
                        document.getElementById('rejection-leave-index').value = index;
                        document.getElementById('rejection-reason-textarea').value = '';
                        toggleModal('rejection-reason-modal', true);
                    }
                }
            }
            document.getElementById('rejection-reason-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const index = document.getElementById('rejection-leave-index').value;
                const reason = document.getElementById('rejection-reason-textarea').value;
                if (index !== '' && reason.trim() !== '') {
                    timeTableData.leaves[index].status = 'rejected';
                    timeTableData.leaves[index].rejectionReason = reason;
                    saveData();
                    toggleModal('rejection-reason-modal', false);
                    renderLeaveRequests();
                } else {
                    alert('Please provide a reason for rejection.');
                }
            });
            function renderFacultyLeaveStatus() {
                const container = document.getElementById('leave-requests-list');
                document.getElementById('view-leaves-modal').querySelector('h3').textContent = 'My Leave Requests';
                const myLeaves = (timeTableData.leaves || []).filter(leave => leave.faculty === currentFacultyName);
                if (myLeaves.length === 0) { container.innerHTML = `<p class="text-center text-slate-500 py-4">You have not requested any leaves.</p>`; return; }
                container.innerHTML = myLeaves.map(leave => {
                    const statusStyles = getStatusStyles(leave.status);
                    const rejectionInfo = (leave.status === 'rejected' && leave.rejectionReason) ? `
                        <div class="mt-3 pt-3 border-t bg-red-50 p-3 rounded-b-lg">
                            <p class="text-sm font-semibold text-red-800">Reason for Rejection:</p>
                            <p class="text-sm text-red-700">${leave.rejectionReason}</p>
                        </div>
                    ` : '';
                    return `
                    <div class="border rounded-lg bg-white shadow-sm">
                        <div class="p-4">
                            <div class="flex justify-between items-start">
                                <div><p class="font-bold text-lg">${leave.faculty}</p><p class="text-sm text-slate-600">Requested Leave on: <span class="font-semibold">${leave.date}</span></p></div>
                                <span class="text-xs font-semibold uppercase px-2 py-1 rounded-full ${statusStyles.bg} ${statusStyles.text}">${leave.status}</span>
                            </div>
                            <p class="mt-3 pt-3 border-t text-slate-700">${leave.reason}</p>
                        </div>
                        ${rejectionInfo}
                    </div>`
                }).join('');
            }
            function renderLeaveRequests() {
                const container = document.getElementById('leave-requests-list');
                document.getElementById('view-leaves-modal').querySelector('h3').textContent = 'Faculty Leave Requests';
                const leaves = timeTableData.leaves || [];
                if (leaves.length === 0) { container.innerHTML = `<p class="text-center text-slate-500 py-4">No leave requests found.</p>`; return; }
                container.innerHTML = leaves.map((leave, index) => {
                    const statusStyles = getStatusStyles(leave.status);
                    const actionButtons = leave.status === 'pending' ? `<div class="flex gap-2"><button data-leave-index="${index}" data-action="approved" class="approve-leave-btn text-sm bg-green-500 hover:bg-green-600 text-white font-semibold py-1 px-3 rounded-full smooth-transition">Approve & Reschedule</button><button data-leave-index="${index}" data-action="rejected" class="reject-leave-btn text-sm bg-red-500 hover:bg-red-600 text-white font-semibold py-1 px-3 rounded-full smooth-transition">Reject</button></div>` : '';
                    return `<div class="p-4 border rounded-lg bg-white shadow-sm"><div class="flex flex-wrap justify-between items-start gap-2"><div><p class="font-bold text-lg">${leave.faculty}</p><p class="text-sm text-slate-600">Requesting Leave on: <span class="font-semibold">${leave.date}</span></p></div><div class="flex items-center gap-4"><span class="text-xs font-semibold uppercase px-2 py-1 rounded-full ${statusStyles.bg} ${statusStyles.text}">${leave.status}</span>${actionButtons}</div></div><p class="mt-3 pt-3 border-t text-slate-700">${leave.reason}</p></div>`;
                }).join('');
                document.querySelectorAll('.approve-leave-btn, .reject-leave-btn').forEach(btn => { btn.addEventListener('click', handleLeaveAction); });
            }

            // --- STUDENT MANAGEMENT (HOD) ---
            manageStudentsBtn.addEventListener('click', () => { setupStudentManagementModal(); toggleModal('manage-students-modal', true); });
            function setupStudentManagementModal() {
                const deptContainer = document.getElementById('ms-dept-select-container');
                const yearContainer = document.getElementById('ms-year-select-container');
                const sectionContainer = document.getElementById('ms-section-select-container');
                const deptSelect = createSelect('ms-dept', 'Department', timeTableData.departments, deptContainer);
                const yearSelect = createSelect('ms-year', 'Year', timeTableData.years, yearContainer);
                const sectionSelect = createSelect('ms-section', 'Section', timeTableData.sections, sectionContainer);
                const contentDiv = document.getElementById('student-management-content');
                function updateStudentList() {
                    const [dept, year, section] = [deptSelect.value, yearSelect.value, sectionSelect.value];
                    if (dept && year && section) { contentDiv.classList.remove('hidden'); renderStudentManagementList(dept, year, section); } else { contentDiv.classList.add('hidden'); }
                }
                [deptSelect, yearSelect, sectionSelect].forEach(sel => sel.addEventListener('change', updateStudentList));
                document.getElementById('add-student-form').onsubmit = (e) => { e.preventDefault(); const [dept, year, section] = [deptSelect.value, yearSelect.value, sectionSelect.value]; const newId = document.getElementById('new-student-id').value.trim(); const newName = document.getElementById('new-student-name').value.trim(); handleAddStudent(dept, year, section, newId, newName); };
                updateStudentList();
            }
            function renderStudentManagementList(dept, year, section) {
                const container = document.getElementById('student-management-list');
                const students = timeTableData.students[dept]?.[year]?.[section] || [];
                if (students.length === 0) { container.innerHTML = '<p class="text-slate-500 text-center">No students found for this class.</p>'; return; }
                container.innerHTML = students.map(student => `<div class="flex justify-between items-center p-2 border-b"><div><span class="font-medium">${student.name}</span><span class="text-sm text-slate-500 ml-2">(${student.id})</span></div><button data-id="${student.id}" class="remove-student-btn text-red-500 hover:text-red-700 font-semibold text-sm">Remove</button></div>`).join('');
                document.querySelectorAll('.remove-student-btn').forEach(btn => { btn.addEventListener('click', (e) => { const studentId = e.target.dataset.id; handleRemoveStudent(dept, year, section, studentId); }); });
            }
            function handleRemoveStudent(dept, year, section, studentId) {
                const students = timeTableData.students[dept]?.[year]?.[section];
                if (students) { timeTableData.students[dept][year][section] = students.filter(s => s.id !== studentId); saveData(); renderStudentManagementList(dept, year, section); }
            }
            function handleAddStudent(dept, year, section, newId, newName) {
                const errorEl = document.getElementById('student-add-error');
                if (!newId || !newName) { errorEl.textContent = 'Both Student ID and Name are required.'; errorEl.classList.remove('hidden'); return; }
                if (!timeTableData.students[dept]) timeTableData.students[dept] = {};
                if (!timeTableData.students[dept][year]) timeTableData.students[dept][year] = {};
                if (!timeTableData.students[dept][year][section]) timeTableData.students[dept][year][section] = [];
                const students = timeTableData.students[dept][year][section];
                if (students.some(s => s.id === newId)) { errorEl.textContent = 'A student with this ID already exists in this class.'; errorEl.classList.remove('hidden'); } else { errorEl.classList.add('hidden'); students.push({ id: newId, name: newName }); students.sort((a, b) => a.name.localeCompare(b.name)); saveData(); renderStudentManagementList(dept, year, section); document.getElementById('add-student-form').reset(); }
            }
            
            // --- AI ATTENDANCE ---
            function openAIAttendanceModal(classInfo) {
                currentClassInfoForAttendance = classInfo;
                const contentContainer = document.getElementById('ai-attendance-content');
                
                contentContainer.innerHTML = `
                    <div class="text-center">
                        <div class="w-full h-48 bg-slate-800 rounded-lg flex items-center justify-center mb-4">
                            <p class="text-slate-400">Simulating Classroom Camera Feed...</p>
                        </div>
                        <p class="text-slate-600 mb-6">Press "Start AI Scan" to begin automatic attendance.</p>
                        <button id="start-ai-scan-btn" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg smooth-transition">Start AI Scan</button>
                    </div>`;

                document.getElementById('start-ai-scan-btn').addEventListener('click', runAIAttendanceScan);
                toggleModal('ai-attendance-modal', true);
            }

            function runAIAttendanceScan() {
                const contentContainer = document.getElementById('ai-attendance-content');
                const messages = [
                    "Accessing classroom camera...",
                    "Detecting faces in the frame...",
                    "Comparing faces against the class roster...",
                    "Cross-referencing with student database..."
                ];
                let messageIndex = 0;

                contentContainer.innerHTML = `<div class="text-center"><div class="loader mx-auto mb-4"></div><p id="ai-status-message" class="text-slate-600 font-semibold">${messages[0]}</p></div>`;
                const statusMessage = document.getElementById('ai-status-message');

                const interval = setInterval(() => {
                    messageIndex++;
                    if (messageIndex < messages.length) {
                        statusMessage.textContent = messages[messageIndex];
                    } else {
                        clearInterval(interval);
                        displayAIAttendanceResults();
                    }
                }, 1000);
            }
            
            function displayAIAttendanceResults() {
                const { dept, year, section } = currentClassInfoForAttendance;
                const students = timeTableData.students[dept]?.[year]?.[section] || [];
                const totalStudents = students.length;
                
                // Simulate some students being absent
                const shuffled = [...students].sort(() => 0.5 - Math.random());
                const absentCount = Math.floor(Math.random() * 3); // 0, 1, or 2 absent students
                const absentStudents = shuffled.slice(0, absentCount);
                const presentCount = totalStudents - absentCount;
                
                const attendanceRecord = {};
                students.forEach(s => {
                    if (absentStudents.some(as => as.id === s.id)) {
                        attendanceRecord[s.id] = 'absent';
                    } else {
                        attendanceRecord[s.id] = 'present';
                    }
                });

                const contentContainer = document.getElementById('ai-attendance-content');
                let absentListHTML = absentStudents.length > 0 ?
                    `<p class="text-sm font-semibold mt-4 mb-2">The following students were not detected:</p>
                     <ul class="text-left text-sm text-red-600 list-disc list-inside">${absentStudents.map(s => `<li>${s.name}</li>`).join('')}</ul>` :
                    `<p class="text-sm text-green-600 mt-4">All students were detected.</p>`;
                
                contentContainer.innerHTML = `
                    <div class="text-center">
                        <h4 class="text-xl font-bold mb-2">Scan Complete!</h4>
                        <p><span class="font-bold text-2xl text-green-600">${presentCount}</span> / ${totalStudents} students marked as <span class="font-semibold text-green-600">Present</span>.</p>
                        <p><span class="font-bold text-2xl text-red-600">${absentCount}</span> student(s) marked as <span class="font-semibold text-red-600">Absent</span>.</p>
                        <div class="my-4 p-3 bg-slate-50 rounded-lg">${absentListHTML}</div>
                        <div class="flex flex-col sm:flex-row gap-2 mt-6">
                            <button id="ai-review-btn" class="w-full bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold py-2 px-4 rounded-lg smooth-transition">Review & Edit Manually</button>
                            <button id="ai-confirm-btn" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg smooth-transition">Confirm & Save</button>
                        </div>
                    </div>`;

                document.getElementById('ai-confirm-btn').addEventListener('click', () => {
                    const { dept, year, section, slotIndex } = currentClassInfoForAttendance;
                    const today = getTodayDateString();
                    if (!timeTableData.attendance[today]) timeTableData.attendance[today] = {};
                    if (!timeTableData.attendance[today][slotIndex]) timeTableData.attendance[today][slotIndex] = {};
                    const classKey = `${dept}-${year}-${section}`;
                    timeTableData.attendance[today][slotIndex][classKey] = attendanceRecord;
                    saveData();
                    toggleModal('ai-attendance-modal', false);
                });

                document.getElementById('ai-review-btn').addEventListener('click', () => {
                    toggleModal('ai-attendance-modal', false);
                    openAttendanceModal(currentClassInfoForAttendance, attendanceRecord);
                });
            }

            // --- AI & HOD MANAGEMENT FEATURE HANDLERS ---
            function openProjectIdeaModal(studentInfo) {
                const { year } = studentInfo;
                const subjects = timeTableData.subjects[year] || [];
                updateSelectOptions(document.getElementById('project-subject-select'), subjects, 'Select a subject...');
                toggleModal('project-idea-modal', true);
            }
            document.getElementById('project-idea-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const subject = document.getElementById('project-subject-select').value;
                toggleModal('project-idea-modal', false);
                document.getElementById('gemini-modal-title').textContent = `✨ Project Ideas for ${subject}`;
                const prompt = `I am a final year undergraduate engineering student. Please generate 3-4 innovative project ideas related to the subject "${subject}".
                For each idea, provide:
                1. A catchy project title.
                2. A brief one-paragraph description of the project.
                3. A list of key technologies or concepts that would be used.
                Format the response using Markdown, with a clear heading for each project idea.`;
                const result = await callGeminiAPI(prompt);
                if (result) {
                    geminiResult.innerHTML = result.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                }
            });

            async function handleAutoGenerateSchedule() {
                const [dept, year, section] = [document.getElementById('h-dept').value, document.getElementById('h-year').value, document.getElementById('h-section').value];
                if (!dept || !year || !section) return;

                document.getElementById('gemini-modal-title').textContent = `✨ Generating Schedule Options for ${dept}-${year}-${section}`;
                toggleModal('gemini-modal', true);
                document.getElementById('gemini-loading').classList.remove('hidden');
                document.getElementById('gemini-result').innerHTML = `<p class="text-center">Generating 3 unique timetable options... This may take a moment.</p>`;

                const subjects = timeTableData.subjects[year];
                const faculty = timeTableData.faculty[dept];
                const basePrompt = `You are an expert academic scheduler for an engineering college. Generate a 5-day weekly class schedule. Return the output *only* as a valid JSON object with no other text or markdown formatting.
                Details:
                - Department: ${dept}, Year: ${year}, Section: ${section}
                - Days: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"]
                - Time slots per day: ${(timeTableData.timeSlots || []).length}
                - Subjects: ${JSON.stringify(subjects)}
                - Faculty: ${JSON.stringify(faculty)}
                Constraints: 1. Each day must have an array of ${(timeTableData.timeSlots || []).length} time slots. 2. A slot can be empty (use 'null'). For a filled slot, use an object: {"subject": "...", "faculty": "..."}. 3. Distribute subjects evenly. 4. Do not schedule more than two lab sessions (subjects ending with "LAB") on the same day. Your entire response must be a single JSON object.`;

                const prompts = [
                    basePrompt + " Prioritize putting lab sessions in the afternoon.",
                    basePrompt + " Try to avoid scheduling the same subject twice on the same day, if possible.",
                    basePrompt + " Aim for a balanced distribution, avoiding clustering difficult subjects together."
                ];

                const promises = prompts.map(p => callGeminiAPI(p, scheduleResponseSchema, false));

                try {
                    const results = await Promise.allSettled(promises);
                    const validSchedules = [];

                    results.forEach((res, index) => {
                        if (res.status === 'fulfilled' && res.value) {
                            try {
                                let cleanedResult = res.value.trim();
                                const jsonMatch = cleanedResult.match(/\{[\s\S]*\}/);
                                if (!jsonMatch) { throw new Error(`Option ${index + 1}: No valid JSON object found.`); }
                                const schedule = JSON.parse(jsonMatch[0]);
                                if (days.every(day => schedule[day] && Array.isArray(schedule[day]) && schedule[day].length === (timeTableData.timeSlots || []).length)) {
                                    validSchedules.push(schedule);
                                } else { console.warn(`Option ${index + 1} has an invalid structure.`); }
                            } catch (e) { console.error(`Error parsing schedule option ${index + 1}:`, e); }
                        }
                    });

                    toggleModal('gemini-modal', false);

                    if (validSchedules.length > 0) {
                        displayTimetableOptions(validSchedules, { dept, year, section });
                    } else {
                        document.getElementById('gemini-loading').classList.add('hidden');
                        geminiResult.innerHTML = `<p class="text-red-500 font-semibold">Sorry, the AI failed to generate any valid schedules. Please try again.</p>`;
                        toggleModal('gemini-modal', true);
                    }
                } catch (error) {
                    toggleModal('gemini-modal', false);
                    document.getElementById('gemini-loading').classList.add('hidden');
                    geminiResult.innerHTML = `<p class="text-red-500 font-semibold">An error occurred while generating schedules. ${error.message}</p>`;
                    toggleModal('gemini-modal', true);
                }
            }

            function renderTimetablePreview(scheduleData) {
                let table = `<table class="w-full text-xs border-collapse text-center"><thead><tr class="bg-slate-100"><th class="p-1 border">Time</th>${days.map(d => `<th class="p-1 border">${d.substring(0,3)}</th>`).join('')}</tr></thead><tbody>`;
                (timeTableData.timeSlots || []).forEach((slot, i) => {
                    table += `<tr class="bg-white"><td class="p-1 border font-medium text-slate-600">${slot.split(' ')[0]}</td>`;
                    days.forEach(day => {
                        const period = scheduleData[day]?.[i];
                        const content = period ? `<div class="font-semibold" title="${period.subject}">${period.subject.split(' ').map(w=>w[0]).join('') || period.subject}</div><div class="text-slate-500" title="${period.faculty}">${period.faculty.split(' ')[1]}</div>` : '-';
                        table += `<td class="p-1 border h-12">${content}</td>`;
                    });
                    table += `</tr>`;
                });
                table += '</tbody></table>';
                return table;
            }

            function displayTimetableOptions(schedules, classInfo) {
                const container = document.getElementById('timetable-options-container');
                container.innerHTML = '';

                schedules.forEach((schedule, index) => {
                    const card = document.createElement('div');
                    card.className = 'p-4 border rounded-xl bg-white shadow-sm flex flex-col';
                    card.innerHTML = `
                        <h4 class="font-bold text-lg text-center mb-3">Option ${index + 1}</h4>
                        <div class="overflow-x-auto flex-grow">${renderTimetablePreview(schedule)}</div>
                        <button data-schedule-index="${index}" class="select-timetable-btn mt-4 w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg smooth-transition">Select this Timetable</button>
                    `;
                    container.appendChild(card);
                });
                
                window.generatedSchedules = schedules; 
                
                document.querySelectorAll('.select-timetable-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const index = e.target.dataset.scheduleIndex;
                        const selectedSchedule = window.generatedSchedules[index];
                        
                        timeTableData.schedule[classInfo.dept][classInfo.year][classInfo.section] = selectedSchedule;
                        saveData();
                        renderTimetable(selectedSchedule, getCurrentTimeInfo());
                        
                        delete window.generatedSchedules;
                        toggleModal('timetable-options-modal', false);
                    });
                });

                toggleModal('timetable-options-modal', true);
            }

            async function handleCreateLessonPlan(subject) {
                document.getElementById('gemini-modal-title').textContent = `✨ Lesson Plan for ${subject}`;
                const prompt = `You are an experienced engineering professor. Create a detailed 1-hour lesson plan for an undergraduate lecture on the subject: "${subject}".
                The plan should include:
                - Learning Objectives (3-4 clear goals).
                - A 5-minute 'hook' or introduction to grab student interest.
                - Core Concepts to Cover (a list of topics with estimated time for each, totaling about 40 minutes).
                - An in-class activity or discussion question (10 minutes).
                - A 5-minute wrap-up and summary.
                Format this as a structured plan using Markdown for headings and lists.`;
                const result = await callGeminiAPI(prompt);
                if (result) {
                    let html = result.replace(/\n\*/g, '<br>•').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
                    geminiResult.innerHTML = html;
                }
            }
            
            async function handleCreateStudyPlan(studentInfo) {
                document.getElementById('gemini-modal-title').textContent = `✨ Personalized Study Plan`;
                const { dept, year, section } = studentInfo;
                const subjects = timeTableData.subjects[year] || [];
                const schedule = timeTableData.schedule[dept]?.[year]?.[section];
                
                let scheduleString = "";
                if(schedule){
                    days.forEach(day => {
                        scheduleString += `${day}: `;
                        const dailySchedule = schedule[day].map((p, i) => p ? `${(timeTableData.timeSlots || [])[i]} - ${p.subject}` : null).filter(Boolean);
                        scheduleString += dailySchedule.join(', ') + ". ";
                    });
                }

                const prompt = `You are an expert academic advisor for engineering students. A student in Year "${year}" of "${dept}" needs a personalized weekly study plan.
                
                Student's Details:
                - Subjects: ${subjects.join(', ')}
                - Current Class Schedule: ${scheduleString}

                Please generate a realistic and encouraging weekly study plan that integrates with their existing classes. The plan should:
                1.  Schedule specific study blocks for various subjects outside of class hours.
                2.  Suggest effective study techniques for different types of subjects (e.g., practice problems for math-heavy subjects, concept mapping for theoretical subjects).
                3.  Incorporate short breaks to avoid burnout.
                4.  Be organized by day (Monday to Sunday).
                
                Format the response clearly using Markdown headings for each day and bullet points for the schedule.`;
                const result = await callGeminiAPI(prompt);
                if (result) {
                    let html = result.replace(/\n\*/g, '<br>•').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
                    geminiResult.innerHTML = html;
                }
            }
            async function handleFindSubstitute(facultyOnLeave, leaveDate) {
                // 1. Find department of the faculty
                let department = null;
                for (const dept in timeTableData.faculty) {
                    if (timeTableData.faculty[dept].includes(facultyOnLeave)) {
                        department = dept;
                        break;
                    }
                }
                if (!department) return `<p class="text-sm text-slate-500">Could not determine department for faculty. Unable to suggest substitute.</p>`;
                
                // 2. Find classes on that day for the faculty
                const leaveDayIndex = new Date(leaveDate).getDay() - 1;
                if (leaveDayIndex < 0 || leaveDayIndex > 4) return `<p class="text-sm text-slate-500">Leave is on a weekend. No substitute needed.</p>`;
                const dayOfWeek = days[leaveDayIndex];
                
                const missedClasses = [];
                timeTableData.years.forEach(year => {
                    timeTableData.sections.forEach(section => {
                        const schedule = timeTableData.schedule?.[department]?.[year]?.[section];
                        if (schedule && schedule[dayOfWeek]) {
                            schedule[dayOfWeek].forEach((period, i) => {
                                if (period && period.faculty === facultyOnLeave) {
                                    missedClasses.push({ subject: period.subject, time: (timeTableData.timeSlots || [])[i], class: `${department}-${year}-${section}` });
                                }
                            });
                        }
                    });
                });

                if (missedClasses.length === 0) return `<p class="text-sm text-slate-500">You have no classes scheduled on ${leaveDate}, so no substitute is needed.</p>`;

                // 3. Get workload of other faculty in the same department
                const facultyList = timeTableData.faculty[department].filter(f => f !== facultyOnLeave);
                const workload = {};
                facultyList.forEach(f => {
                    workload[f] = { total: 0, busySlots: [] };
                });

                facultyList.forEach(facultyName => {
                    let count = 0;
                    timeTableData.years.forEach(year => {
                        timeTableData.sections.forEach(section => {
                            const schedule = timeTableData.schedule?.[department]?.[year]?.[section];
                            if (schedule) {
                                days.forEach(day => {
                                    schedule[day].forEach((period, i) => {
                                        if (period && period.faculty === facultyName) {
                                            count++;
                                            if (day === dayOfWeek) {
                                                workload[facultyName].busySlots.push(i);
                                            }
                                        }
                                    });
                                });
                            }
                        });
                    });
                    workload[facultyName].total = count;
                });
                
                const prompt = `You are an intelligent academic assistant. A faculty member needs a substitute for their classes. Analyze the provided data to suggest the best substitute(s).
                
                Data:
                - Faculty on Leave: ${facultyOnLeave}
                - Department: ${department}
                - Leave Date: ${leaveDate} (${dayOfWeek})
                - Classes to be Covered: ${JSON.stringify(missedClasses)}
                - Availability and weekly workload of other faculty in the same department: ${JSON.stringify(workload)}. (The 'busySlots' are for the day of the leave).

                Task:
                1. For each missed class, identify 1-2 faculty members from the workload list who could be a suitable substitute.
                2. A substitute is ONLY viable if they are NOT busy during the class time slot. For example, if a class is at 9:00 (slot 0), a substitute cannot have 0 in their 'busySlots'.
                3. Prioritize substitutes with a lower total weekly workload.
                4. Provide a brief justification for each suggestion.
                5. If no one is available for a slot, state that clearly.
                
                Format your response as a clear, structured report using Markdown for headings and lists. Address the faculty member directly ("Here are some potential substitute suggestions for your classes:").`;

                const result = await getGeminiTextOnly(prompt); // Using getGeminiTextOnly to avoid the main modal for this sub-task
                return result.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            }


            async function handleSuggestTopics(subject) {
                document.getElementById('gemini-modal-title').textContent = `✨ Lecture Topics for ${subject}`;
                const prompt = `I am an engineering professor preparing a one-hour lecture on the subject "${subject}". Suggest 3 to 5 key topics or concepts I could cover in today's class. For each topic, provide a brief, one-sentence description. Format the response clearly with headings for each topic.`;
                const result = await callGeminiAPI(prompt);
                if (result) { geminiResult.innerHTML = result.replace(/\n/g, '<br>'); }
            }

            async function handleGetStudyTips(subject) {
                document.getElementById('gemini-modal-title').textContent = `✨ Study Tips for ${subject}`;
                const prompt = `I am an engineering student. Provide three concise and actionable study tips for the undergraduate subject "${subject}". Format them as a numbered list with brief explanations.`;
                const result = await callGeminiAPI(prompt);
                if (result) { geminiResult.innerHTML = result.replace(/\n/g, '<br>'); }
            }
            
            async function handleGetAttendanceInsights() {
                const [dept, year, section] = [document.getElementById('h-dept').value, document.getElementById('h-year').value, document.getElementById('h-section').value];
                const date = document.getElementById('report-date').value;
                if (!dept || !year || !section || !date) return;
                document.getElementById('gemini-modal-title').textContent = `✨ Attendance Insights for ${date}`;
                const attendanceForDay = timeTableData.attendance[date] || {};
                const classKey = `${dept}-${year}-${section}`;
                const students = timeTableData.students[dept]?.[year]?.[section] || [];
                const reportData = [];
                (timeTableData.timeSlots || []).forEach((slot, i) => {
                    const classSchedule = timeTableData.schedule?.[dept]?.[year]?.[section]?.[days[new Date(date).getDay() - 1]]?.[i];
                    if (classSchedule) {
                        const attendanceRecord = attendanceForDay[i]?.[classKey];
                        if (attendanceRecord) {
                            const absentees = students.filter(s => attendanceRecord[s.id] === 'absent').map(s => s.name);
                            reportData.push({ time: slot, subject: classSchedule.subject, faculty: classSchedule.faculty, present: students.length - absentees.length, absent: absentees.length, absentees: absentees });
                        }
                    }
                });
                if (reportData.length === 0) {
                    geminiResult.innerHTML = `<p>No attendance data found for ${dept}-${year}-${section} on ${date}.</p>`;
                    toggleModal('gemini-modal', true);
                    return;
                }
                const prompt = `As an academic analyst, review the following daily attendance data for the ${dept} ${year}-${section} class on ${date}. Provide a concise summary with actionable insights for the Head of Department.
                Data: ${JSON.stringify(reportData, null, 2)}
                Focus on:
                - Overall attendance rate for the day.
                - Any specific classes with unusually high absenteeism.
                - Any students who were absent for multiple classes.
                - Conclude with a brief, overall assessment.
                Format the response as a simple report with bullet points.`;
                const result = await callGeminiAPI(prompt);
                if(result) { geminiResult.innerHTML = result.replace(/\n/g, '<br>'); }
            }

            async function handleGenerateQuiz(subject) {
                document.getElementById('gemini-modal-title').textContent = `✨ Quiz Questions for ${subject}`;
                const prompt = `You are an expert question paper setter for an engineering college. Generate a 5-question multiple-choice quiz on the undergraduate subject "${subject}".
                - The questions should be challenging but appropriate for a mid-lecture surprise quiz.
                - For each question, provide four options (A, B, C, D).
                - Clearly indicate the correct answer for each question.
                Format the output cleanly using Markdown for headings and lists.`;
                const result = await callGeminiAPI(prompt);
                if (result) {
                    let html = result.replace(/\n\*/g, '<br>•').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
                    geminiResult.innerHTML = html;
                }
            }

            async function handleWorkloadAnalysis(dept) {
                document.getElementById('gemini-modal-title').textContent = `✨ Faculty Workload Analysis for ${dept}`;
                const workload = {};
                const facultyList = timeTableData.faculty[dept] || [];
                facultyList.forEach(f => workload[f] = 0);
                timeTableData.years.forEach(year => {
                    timeTableData.sections.forEach(section => {
                        const schedule = timeTableData.schedule?.[dept]?.[year]?.[section];
                        if (schedule) {
                            days.forEach(day => {
                                schedule[day].forEach(period => {
                                    if (period && period.faculty && facultyList.includes(period.faculty)) {
                                        workload[period.faculty]++;
                                    }
                                });
                            });
                        }
                    });
                });
                const prompt = `You are an academic management analyst for an engineering college. Here is the weekly class count for each faculty member in the ${dept} department:
                ${JSON.stringify(workload, null, 2)}
                Please provide a concise analysis of this workload distribution. 
                1.  Calculate the average number of classes per faculty member.
                2.  Identify any faculty members who are significantly overloaded (e.g., >150% of average) or underloaded (e.g., <50% of average).
                3.  Provide a brief summary and suggest if the distribution seems balanced or not.
                Format the response as a simple, easy-to-read report using a mix of paragraphs and bullet points.`;
                const result = await callGeminiAPI(prompt);
                if(result) { geminiResult.innerHTML = result.replace(/\n/g, '<br>'); }
            }

            // --- HOD Timetable Editing ---
            function handleDragStart(e) {
                draggedElement = e.target;
                const sourceDay = e.target.dataset.day;
                const sourceSlotIndex = e.target.dataset.slotIndex;
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', JSON.stringify({ sourceDay, sourceSlotIndex }));
                setTimeout(() => { e.target.style.opacity = '0.5'; }, 0);
            }
            function handleDragOver(e) { e.preventDefault(); return false; }
            function handleDragEnter(e) { const targetCell = e.target.closest('td[data-day]'); if (targetCell && targetCell !== draggedElement) { targetCell.classList.add('bg-red-100'); } }
            function handleDragLeave(e) { const targetCell = e.target.closest('td[data-day]'); if (targetCell) { targetCell.classList.remove('bg-red-100'); } }
            function handleDrop(e) {
                e.stopPropagation(); 
                if (draggedElement) {
                    draggedElement.style.opacity = '1';
                    const dropTarget = e.target.closest('td[data-day]');
                    dropTarget.classList.remove('bg-red-100');

                    if (draggedElement !== dropTarget) {
                        const data = JSON.parse(e.dataTransfer.getData('text/plain'));
                        const sourceDay = data.sourceDay;
                        const sourceSlotIndex = parseInt(data.sourceSlotIndex);
                        const targetDay = dropTarget.dataset.day;
                        const targetSlotIndex = parseInt(dropTarget.dataset.slotIndex);
                        const dept = document.getElementById('h-dept').value;
                        const year = document.getElementById('h-year').value;
                        const section = document.getElementById('h-section').value;

                        if (dept && year && section) {
                            const schedule = timeTableData.schedule[dept][year][section];
                            const sourceData = schedule[sourceDay][sourceSlotIndex];
                            const targetData = schedule[targetDay][targetSlotIndex];
                            schedule[sourceDay][sourceSlotIndex] = targetData;
                            schedule[targetDay][targetSlotIndex] = sourceData;
                            saveData();
                            renderTimetable(schedule, getCurrentTimeInfo());
                        }
                    }
                }
                draggedElement = null;
                return false;
            }

            manageTimeSlotsBtn.addEventListener('click', () => {
                const container = document.getElementById('time-slots-inputs');
                container.innerHTML = '';
                (timeTableData.timeSlots || []).forEach((slot, index) => {
                    const div = document.createElement('div');
                    div.innerHTML = `<label for="ts-input-${index}" class="block text-sm font-medium text-slate-700">Slot ${index + 1}</label><input type="text" id="ts-input-${index}" value="${slot}" class="mt-1 block w-full p-2 border border-slate-300 rounded-md">`;
                    container.appendChild(div);
                });
                toggleModal('manage-time-slots-modal', true);
            });

            document.getElementById('manage-time-slots-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const newTimeSlots = [];
                const inputs = document.querySelectorAll('#time-slots-inputs input');
                inputs.forEach(input => { newTimeSlots.push(input.value); });
                timeTableData.timeSlots = newTimeSlots;
                saveData();
                toggleModal('manage-time-slots-modal', false);
                const dept = document.getElementById('h-dept').value;
                const year = document.getElementById('h-year').value;
                const section = document.getElementById('h-section').value;
                if (dept && year && section) { renderTimetable(timeTableData.schedule[dept][year][section], getCurrentTimeInfo()); }
            });

            // --- NEW: AI RESCHEDULING FOR LEAVES ---
            async function initiateAIRescheduling(leave, leaveIndex) {
                 document.getElementById('gemini-modal-title').textContent = `✨ AI Rescheduling for ${leave.faculty}`;
                 toggleModal('gemini-modal', true);
                 document.getElementById('gemini-loading').classList.remove('hidden');
                 document.getElementById('gemini-result').innerHTML = `<p class="text-center">Analyzing schedules and faculty workload to find the best solution...</p>`;
                 
                 // 1. Find department
                 let department = null;
                 for (const dept in timeTableData.faculty) {
                     if (timeTableData.faculty[dept].includes(leave.faculty)) {
                         department = dept;
                         break;
                     }
                 }
                 if (!department) { geminiResult.innerHTML = `<p class="text-red-500">Could not determine department for faculty. Cannot proceed.</p>`; return; }
                 
                 // 2. Find missed classes and available slots for all relevant classes
                 const leaveDayIndex = new Date(leave.date).getDay() - 1;
                 const dayOfWeek = days[leaveDayIndex];
                 const missedClasses = [];
                 const classFreeSlots = {}; // { "CSE-II-A": [{day:"Tuesday", slotIndex: 4}], ... }
                 
                 timeTableData.years.forEach(year => {
                     timeTableData.sections.forEach(section => {
                        const classKey = `${department}-${year}-${section}`;
                        classFreeSlots[classKey] = [];
                        const schedule = timeTableData.schedule?.[department]?.[year]?.[section];
                        if (schedule) {
                            days.forEach((day, dayIndex) => {
                                schedule[day].forEach((period, i) => {
                                    if (!period) { classFreeSlots[classKey].push({ day, slotIndex: i }); }
                                    if (day === dayOfWeek && period?.faculty === leave.faculty) {
                                        missedClasses.push({ dept: department, year, section, day: leaveDayIndex, slotIndex: i, subject: period.subject });
                                    }
                                });
                            });
                        }
                     });
                 });
                 
                 if (missedClasses.length === 0) {
                    timeTableData.leaves[leaveIndex].status = 'approved';
                    saveData();
                    renderLeaveRequests();
                    document.getElementById('gemini-loading').classList.add('hidden');
                    geminiResult.innerHTML = `<p class="text-green-600 font-semibold">Leave Approved.</p><p>No classes were scheduled for ${leave.faculty} on ${leave.date}, so no changes to the timetable were needed.</p>`;
                    return;
                 }

                 // 3. Get workload and availability of other faculty
                 const facultyList = timeTableData.faculty[department].filter(f => f !== leave.faculty);
                 const facultyContext = {};
                 facultyList.forEach(f => {
                     facultyContext[f] = { totalWeeklyClasses: 0, busySlotsOnLeaveDay: [] };
                     let count = 0;
                     timeTableData.years.forEach(year => {
                        timeTableData.sections.forEach(section => {
                            const schedule = timeTableData.schedule?.[department]?.[year]?.[section];
                            if(schedule) {
                                days.forEach(day => {
                                    schedule[day].forEach((period, i) => {
                                        if (period?.faculty === f) {
                                            count++;
                                            if (day === dayOfWeek) { facultyContext[f].busySlotsOnLeaveDay.push(i); }
                                        }
                                    });
                                });
                            }
                        });
                     });
                     facultyContext[f].totalWeeklyClasses = count;
                 });
                 
                 const labSubjects = Object.values(timeTableData.subjects).flat().filter(s => s.toUpperCase().includes('LAB'));

                 const prompt = `You are an expert academic scheduler. A faculty member has an approved leave, and you must rearrange their classes for that day. Provide a series of changes as a JSON array.

                    **Context:**
                    - Faculty on Leave: "${leave.faculty}" in "${department}" department.
                    - Leave Date: ${leave.date} (${dayOfWeek}).
                    - "day" properties are numerical indexes where Monday=0, Tuesday=1, ..., Friday=4.
                    - Missed Classes: ${JSON.stringify(missedClasses)}
                    - Potential substitutes from the same department, their weekly class load, and their busy slots on the day of leave: ${JSON.stringify(facultyContext)}
                    - List of free slots for each class for the entire week: ${JSON.stringify(classFreeSlots)}
                    - A list of all lab subjects which are typically 2-3 hours long and should be in the afternoon if possible: ${JSON.stringify(labSubjects)}

                    **Your Task:**
                    For each missed class, decide on the best action and create a JSON object for it. The possible actions are:
                    1.  **"substitute"**: The best option. Find an available faculty member from the context. A substitute is available if the class's 'slotIndex' is NOT in their 'busySlotsOnLeaveDay'. Choose the substitute with the lowest 'totalWeeklyClasses'.
                    2.  **"reschedule"**: If no substitute is available. Find a free slot for that specific class from the 'classFreeSlots' context. Choose the earliest possible free slot in the week.
                    3.  **"no_change"**: ONLY if no substitute OR rescheduling is possible. This is the last resort.
                    
                    **Crucially, a substitute must be qualified. Assume any faculty from the same department is qualified. Also consider the following scheduling principles:**
                    - **Lab Sessions:** Lab subjects (identified in the context) should ideally be handled by substitutes familiar with labs or be rescheduled to afternoon slots. Avoid breaking up multi-hour lab blocks if possible.
                    - **Workload Balance:** Your primary goal is to ensure classes are covered, but use the workload data to make fair substitution choices.

                    **Output Format:**
                    Your response MUST be a valid JSON array of objects. Each object must have the following properties:
                    - "action": (string) "substitute", "reschedule", or "no_change".
                    - "originalClass": (object) The details of the class from the "Missed Classes" list.
                    - "details": (string) A human-readable summary of the change. E.g., "Ms. Imrana Begum (lightest workload) will cover the DBMS class." or "Class rescheduled to Friday at 2:00 PM as no substitute was free."
                    - "changes": (object) An object with the required changes.
                        - For "substitute": { "newFaculty": "Faculty Name" }
                        - For "reschedule": { "newDay": "Day", "newSlotIndex": number }
                        - For "no_change": {}`;
                
                const result = await callGeminiAPI(prompt, rescheduleResponseSchema);

                if(result) {
                    try {
                        let cleanedResult = result.trim();
                        const jsonMatch = cleanedResult.match(/\[[\s\S]*\]/);
                        if (!jsonMatch) { throw new Error("No valid JSON array found in the AI's response."); }
                        const changes = JSON.parse(jsonMatch[0]);
                        displayAIRescheduleConfirmation(changes, leaveIndex);
                    } catch (e) {
                         geminiResult.innerHTML = `<p class="text-red-500">The AI returned an invalid plan. Please approve manually or try again.</p><p class="text-xs text-gray-500 mt-2">${e.message}</p><pre class="bg-gray-100 p-2 rounded text-xs overflow-x-auto mt-2">AI Response:\n${result}</pre>`;
                         console.error("Failed to parse AI reschedule plan:", e, result);
                    }
                }
            }

            function displayAIRescheduleConfirmation(changes, leaveIndex) {
                document.getElementById('gemini-modal-title').textContent = 'AI Reschedule Proposal';
                const geminiResult = document.getElementById('gemini-result');
                const geminiActions = document.getElementById('gemini-modal-actions');

                const renderMiniSlot = (period, highlightClass = '') => {
                    if (!period) {
                        return `<div class="p-2 border border-dashed border-slate-300 rounded-md text-center text-slate-400 text-sm h-full flex items-center justify-center ${highlightClass}">- Free Slot -</div>`;
                    }
                    return `<div class="p-2 border border-slate-300 bg-white rounded-md text-center h-full flex flex-col justify-center ${highlightClass}">
                                <div class="font-bold text-sm">${period.subject}</div>
                                <div class="text-xs text-slate-500">${period.faculty}</div>
                            </div>`;
                };

                let html = '<p class="mb-4">The AI has generated the following plan to handle the approved leave. Please review and confirm the proposed changes below.</p><div class="space-y-4">';
                
                changes.forEach(change => {
                    const { action, originalClass, details, changes: newValues } = change;
                    const schedule = timeTableData.schedule[originalClass.dept][originalClass.year][originalClass.section];
                    const originalPeriodData = schedule[days[originalClass.day]][originalClass.slotIndex];
                    
                    let beforeHTML = '';
                    let afterHTML = '';

                    if (action === 'substitute') {
                        const substitutedPeriod = { ...originalPeriodData, faculty: newValues.newFaculty };
                        beforeHTML = renderMiniSlot(originalPeriodData);
                        afterHTML = renderMiniSlot(substitutedPeriod, 'border-green-500 bg-green-50 border-2');
                    } else if (action === 'reschedule') {
                        const targetPeriodData = schedule[newValues.newDay]?.[newValues.newSlotIndex]; // Should be null
                        beforeHTML = `
                            <div class="flex-1">
                                <p class="text-xs text-center font-semibold mb-1">${days[originalClass.day]}, ${timeTableData.timeSlots[originalClass.slotIndex]}</p>
                                ${renderMiniSlot(originalPeriodData)}
                            </div>
                            <div class="flex-1">
                                 <p class="text-xs text-center font-semibold mb-1">${newValues.newDay}, ${timeTableData.timeSlots[newValues.newSlotIndex]}</p>
                                ${renderMiniSlot(targetPeriodData)}
                            </div>
                        `;
                        afterHTML = `
                            <div class="flex-1">
                                <p class="text-xs text-center font-semibold mb-1">${days[originalClass.day]}, ${timeTableData.timeSlots[originalClass.slotIndex]}</p>
                                ${renderMiniSlot(null, 'border-red-500 bg-red-50 border-2')}
                            </div>
                            <div class="flex-1">
                                 <p class="text-xs text-center font-semibold mb-1">${newValues.newDay}, ${timeTableData.timeSlots[newValues.newSlotIndex]}</p>
                                ${renderMiniSlot(originalPeriodData, 'border-green-500 bg-green-50 border-2')}
                            </div>
                        `;
                    } else { // no_change
                        beforeHTML = renderMiniSlot(originalPeriodData);
                        afterHTML = renderMiniSlot(originalPeriodData, 'border-yellow-500 bg-yellow-50 border-2');
                    }

                    html += `
                    <div class="p-3 bg-slate-100 rounded-lg border border-slate-200">
                        <p class="text-sm text-center text-white bg-blue-600 font-medium p-2 rounded-md mb-3">✨ AI Justification: ${details}</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-stretch">
                            <div class="md:col-span-1">
                                <p class="text-sm font-bold text-center mb-1 text-slate-600">BEFORE</p>
                                <div class="flex gap-2 h-full">
                                    ${action === 'reschedule' ? beforeHTML : `<div class="flex-1">${beforeHTML}</div>`}
                                </div>
                            </div>
                            <div class="md:col-span-1">
                                <p class="text-sm font-bold text-center mb-1 text-slate-600">AFTER</p>
                                <div class="flex gap-2 h-full">
                                    ${action === 'reschedule' ? afterHTML : `<div class="flex-1">${afterHTML}</div>`}
                                </div>
                            </div>
                        </div>
                    </div>
                    `;
                });

                html += '</div>';
                geminiResult.innerHTML = html;
                
                geminiActions.innerHTML = `
                    <button type="button" data-close-modal class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold py-2 px-4 rounded-lg smooth-transition">Cancel</button>
                    <button id="confirm-ai-changes" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg smooth-transition">Confirm & Apply Changes</button>
                `;

                document.getElementById('confirm-ai-changes').addEventListener('click', () => applyAIChanges(changes, leaveIndex));
            }

            function applyAIChanges(changes, leaveIndex) {
                 changes.forEach(change => {
                    const { action, originalClass, changes: newValues } = change;
                    const schedule = timeTableData.schedule[originalClass.dept][originalClass.year][originalClass.section];
                    const originalPeriodData = { ...schedule[days[originalClass.day]][originalClass.slotIndex] };

                    if (action === 'substitute') {
                        schedule[days[originalClass.day]][originalClass.slotIndex].faculty = newValues.newFaculty;
                    } else if (action === 'reschedule') {
                        schedule[days[originalClass.day]][originalClass.slotIndex] = null; // Free up original slot
                        schedule[newValues.newDay][newValues.newSlotIndex] = originalPeriodData;
                    }
                 });

                 timeTableData.leaves[leaveIndex].status = 'approved';
                 saveData();
                 renderLeaveRequests();
                 
                 // Re-render the HOD's current view
                 const dept = document.getElementById('h-dept').value;
                 const year = document.getElementById('h-year').value;
                 const section = document.getElementById('h-section').value;
                 if (dept && year && section) {
                    renderTimetable(timeTableData.schedule[dept][year][section], getCurrentTimeInfo());
                 }
                 
                 geminiResult.innerHTML = `<p class="text-lg text-green-600 font-semibold">Success!</p><p>The leave has been approved and the timetable has been automatically updated with the AI's suggestions.</p>`;
                 document.getElementById('gemini-modal-actions').innerHTML = `<button type="button" data-close-modal class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold py-2 px-4 rounded-lg smooth-transition">Close</button>`;

            }
        });
    </script>
</body>
</html>
          
